<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ароматная Публика</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: inherit;
        }

        :root {
            --primary: #8B5CF6;
            --primary-light: #A78BFA;
            --secondary: #EC4899;
            --bg: #F9FAFB;
            --surface: #FFFFFF;
            --text: #111827;
            --text-secondary: #6B7280;
            --border: #E5E7EB;
            --success: #10B981;
            --men: #3B82F6;
            --women: #EC4899;
            --unisex: #8B5CF6;
        }

        body {
            font-family: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", "Helvetica Neue", Arial, sans-serif;
            background: #fff;
            color: #000;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        body.platform-ios,
        body.platform-macos {
            font-family: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
        }

        body.platform-android {
            font-family: "Roboto", "Noto Sans", "Helvetica Neue", Arial, sans-serif;
        }

        body.platform-windows {
            font-family: "Segoe UI", "Noto Sans", "Helvetica Neue", Arial, sans-serif;
        }

        body.platform-linux {
            font-family: "Noto Sans", "DejaVu Sans", "Liberation Sans", "Helvetica Neue", Arial, sans-serif;
        }

        /* ===== Navigation Bar (fixed top) - DESIGNER STYLE ===== */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 3001;
            background: linear-gradient(180deg, rgba(255,255,255,0.86) 0%, rgba(255,255,255,0.77) 80%, rgba(255,255,255,0) 100%);
            padding-top: var(--sys-safe-top, env(safe-area-inset-top, 0px));
        }

        .nav-header {
            display: flex;
            align-items: center;
            justify-content: center;
            height: var(--tg-header-height, 44px);
            padding: 0 16px;
            position: relative;
        }

        .nav-logo-img {
            height: 36px;
            width: 36px;
            object-fit: contain;
        }

        /* ===== Filters - DESIGNER STYLE ===== */
        .filters-wrap {
            padding: 8px 16px 12px;
        }

        .filters {
            display: flex;
            gap: 4px;
            align-items: center;
            background: rgba(255,255,255,0.88);
            border: 1px solid #fff;
            border-radius: 40px;
            padding: 4px;
            box-shadow: 0 4px 40px rgba(0,0,0,0.16);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            overflow-x: auto;
            scrollbar-width: none;
        }

        .filters::-webkit-scrollbar {
            display: none;
        }

        .filter-btn {
            flex-shrink: 0;
            height: 32px;
            display: flex;
            align-items: center;
            gap: 2px;
            padding: 6px 12px;
            border-radius: 36px;
            border: none;
            background: transparent;
            font-family: inherit;
            font-style: normal;
            font-size: 12px;
            font-weight: 510;
            letter-spacing: -0.48px;
            line-height: 120%;
            color: #000;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .filter-btn.icon-only {
            width: 32px;
            padding: 0;
            justify-content: center;
            border-radius: 32px;
        }

        .filter-btn.with-icon {
            padding-left: 12px;
            padding-right: 8px;
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
        }

        .filter-btn svg {
            flex-shrink: 0;
        }

        /* Sort Bottom Sheet */
        .sort-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 3010;
        }

        .sort-overlay.show { display: block; }

        .sort-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            z-index: 3011;
            padding: 0 16px max(16px, env(safe-area-inset-bottom, 16px));
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }

        .sort-sheet.show {
            transform: translateY(0);
        }

        .sort-sheet-handle {
            width: 32px;
            height: 4px;
            background: #D1D5DB;
            border-radius: 2px;
            margin: 4px auto 20px;
        }

        .sort-sheet-title {
            font-size: 20px;
            font-weight: 510;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.6px;
            margin-bottom: 20px;
        }

        .sort-sheet-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 0;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.56px;
            color: #000;
        }

        .sort-sheet-option:last-child {
            border-bottom: none;
        }

        .sort-sheet-option input {
            display: none;
        }

        .sort-radio {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            background-image: url('icon/circle-no.svg');
            background-size: contain;
            background-repeat: no-repeat;
        }

        .sort-sheet-option input:checked + .sort-radio {
            background-image: url('icon/circle-yes.svg');
        }

        .sort-sheet-buttons {
            display: flex;
            gap: 8px;
            margin-top: 24px;
        }

        .sort-btn-cancel {
            flex: 1;
            padding: 16px 24px;
            border-radius: 51px;
            border: none;
            background: #E3E3E3;
            font-size: 16px;
            font-weight: 510;
            font-style: normal;
            letter-spacing: -0.64px;
            line-height: 120%;
            color: #6E6E76;
            cursor: pointer;
            font-family: inherit;
        }

        .sort-btn-apply {
            flex: 1;
            padding: 16px 24px;
            border-radius: 51px;
            border: none;
            background: #007AFF;
            font-size: 16px;
            font-weight: 510;
            font-style: normal;
            letter-spacing: -0.64px;
            line-height: 120%;
            color: #fff;
            cursor: pointer;
            font-family: inherit;
        }

        /* Sort button active state (gray circle background) */
        .filter-btn.icon-only.sort-active {
            background: #F3F4F6;
        }

        /* Category filter active state with X */
        .filter-btn.cat-active {
            background: #F3F4F6;
        }

        .filter-btn .filter-x {
            width: 16px;
            height: 16px;
            background: #6B7280;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 4px;
            flex-shrink: 0;
        }

        .filter-btn .filter-x svg {
            width: 8px;
            height: 8px;
        }

        /* Brand badge */
        .brand-badge {
            background: #eb4444;
            border-radius: 100px;
            padding: 1px 5px;
            font-size: 10px;
            font-weight: 600;
            color: #fff;
            line-height: 1.2;
            min-width: 16px;
            text-align: center;
            margin-left: 2px;
            position: relative;
            top: -6px;
        }

        /* Brand label under filters */
        .brand-label {
            padding: 0 16px;
            font-size: 20px;
            font-weight: 600;
            font-style: normal;
            color: #000;
            letter-spacing: -0.5px;
        }

        /* Brand sheet options */
        .brand-sheet {
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .brand-sheet-options {
            flex: 1;
            overflow-y: auto;
        }

        .brand-sheet-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 0;
            border-bottom: 1px solid #E5E7EB;
            cursor: pointer;
            font-size: 14px;
            font-weight: 400;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.56px;
            color: #000;
        }

        .brand-sheet-option:last-child {
            border-bottom: none;
        }

        .brand-sheet-option input {
            display: none;
        }

        .brand-checkbox {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            background-image: url('icon/square-no.svg');
            background-size: contain;
            background-repeat: no-repeat;
        }

        .brand-sheet-option input:checked + .brand-checkbox {
            background-image: url('icon/square-yes.svg');
        }

        /* ===== Main scrollable content ===== */
        .content {
            padding-top: 148px;
            padding-bottom: 108px;
        }

        /* ===== Banner - DESIGNER STYLE ===== */
        .banner-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 0;
        }

        .banner-carousel {
            width: 100%;
            height: 144px;
            border-radius: 20px;
            overflow: hidden;
            background: var(--primary);
            position: relative;
            touch-action: pan-y;
        }

        .banner-slides {
            display: flex;
            transition: transform 0.5s ease;
            height: 100%;
        }

        .banner-slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 600;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
        }

        .banner-slide:nth-child(2) { background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%); }
        .banner-slide:nth-child(3) { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); }

        .banner-slide small {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Pagination dots - DESIGNER STYLE */
        .pagination {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }

        .dot {
            width: 4px;
            height: 4px;
            border-radius: 4px;
            background: #bababa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dot.active {
            width: 6px;
            height: 6px;
            background: #6e6e76;
        }

        /* ===== Collections - DESIGNER STYLE ===== */
        .collections {
            display: flex;
            gap: 8px;
            padding: 30px 0 0 16px;
            margin-left: -16px;
            margin-right: -16px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .collections::after {
            content: '';
            flex-shrink: 0;
            width: 8px;
        }

        .collections::-webkit-scrollbar {
            display: none;
        }

        .collection {
            flex-shrink: 0;
            width: 92px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .collection-img {
            width: 92px;
            height: 92px;
            border-radius: 20px;
            overflow: hidden;
            background: #f6f6f6;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .collection-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .collection-name {
            font-style: normal;
            font-size: 12px;
            font-weight: 510;
            letter-spacing: -0.48px;
            text-align: center;
            color: #000;
            line-height: 1.2;
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ===== Product Grid - DESIGNER STYLE ===== */
        .products-section {
            padding: 30px 0 0;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .products {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px 8px;
        }

        .card {
            display: flex;
            flex-direction: column;
            gap: 8px;
            cursor: pointer;
        }

        .card-image-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .card-image {
            width: 100%;
            aspect-ratio: 168 / 220;
            border-radius: 20px;
            overflow: hidden;
            background: #f6f6f6;
            position: relative;
        }

        .card-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-images {
            display: flex;
            height: 100%;
            transition: transform 0.3s;
            touch-action: pan-y;
        }

        .product-image {
            min-width: 100%;
            height: 100%;
            object-fit: cover;
            -webkit-user-drag: none;
            user-select: none;
        }

        .image-dots {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
        }

        .img-dot {
            width: 4px;
            height: 4px;
            border-radius: 4px;
            background: #bababa;
        }

        .img-dot.active {
            width: 6px;
            height: 6px;
            background: #6e6e76;
        }

        .card-fav {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            z-index: 10;
        }

        .card-fav svg {
            width: 100%;
            height: 100%;
        }

        .card-fav .fav-fill { fill: white; }
        .card-fav .fav-outline { fill: #9CA3AF; }
        .card-fav.active .fav-fill { fill: #eb4444; }
        .card-fav.active .fav-outline { fill: #eb4444; }

        .new-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 600;
            z-index: 10;
        }

        .add-to-cart {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
            z-index: 10;
        }

        .card-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .card-prices {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .card-price {
            font-style: normal;
            font-size: 14px;
            font-weight: 590;
            letter-spacing: -0.56px;
            line-height: 1.2;
            color: #000;
        }

        .card-old-price {
            font-style: normal;
            font-size: 12px;
            font-weight: 400;
            letter-spacing: -0.48px;
            line-height: 1.2;
            color: #909096;
            text-decoration: line-through;
        }

        .card-name {
            font-style: normal;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: -0.56px;
            line-height: 1.2;
            color: #000;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ===== Tab Bar (fixed bottom) - DESIGNER STYLE ===== */
        .tab-bar-wrap {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(0deg, rgba(255,255,255,0.86) 0%, rgba(255,255,255,0.77) 80%, rgba(255,255,255,0) 100%);
            padding: 20px 16px;
            padding-bottom: max(20px, env(safe-area-inset-bottom, 20px));
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .tab-bar {
            flex: 1;
            display: flex;
            gap: 4px;
            background: rgba(255,255,255,0.88);
            border: 1px solid #fff;
            border-radius: 24px;
            padding: 4px;
            box-shadow: 0 4px 40px rgba(0,0,0,0.16);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 4px 0;
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            border: none;
            background: transparent;
            font-family: inherit;
        }

        .tab.active {
            background: #e3e3e3;
        }

        .tab-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
        }

        .tab-label {
            font-style: normal;
            font-size: 8px;
            font-weight: 400;
            letter-spacing: -0.24px;
            line-height: 1.2;
            color: #000;
            text-align: center;
        }

        .tab.active .tab-label {
            color: #007aff;
        }

        .tab.active .tab-icon {
            color: #007aff;
        }

        .tab-badge {
            position: absolute;
            top: 0;
            left: 50%;
            margin-left: 5px;
            background: #eb4444;
            border-radius: 100px;
            padding: 2px 4px;
            font-size: 10px;
            font-weight: 590;
            letter-spacing: -0.3px;
            color: #fff;
            line-height: 1.2;
            min-width: 16px;
            text-align: center;
        }

        .tab-avatar {
            width: 22px;
            height: 22px;
            border-radius: 20px;
            background: linear-gradient(180deg, #9edd7d 0%, #55cb68 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tab-avatar span {
            font-size: 10px;
            font-weight: 510;
            letter-spacing: -0.3px;
            color: #fff;
            line-height: 1.2;
        }

        .tab-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .search-btn {
            width: 52px;
            height: 52px;
            flex-shrink: 0;
            border-radius: 40px;
            background: rgba(255,255,255,0.88);
            border: 1px solid #fff;
            box-shadow: 0 4px 40px rgba(0,0,0,0.16);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
        }

        .search-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 2500;
        }

        .search-overlay.show {
            display: block;
        }

        .search-scroll {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: calc(var(--sys-safe-top, env(safe-area-inset-top, 0px)) + var(--tg-header-height, 44px) + 72px) 16px 132px;
        }

        .search-section {
            margin-bottom: 32px;
        }

        .search-section-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .search-section-title,
        .search-results-title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.34px;
            line-height: 1.2;
            color: #B9B9BF;
            margin-bottom: 4px;
        }

        .search-results-title {
            margin-bottom: 12px;
        }

        .search-clear-history {
            border: none;
            background: transparent;
            padding: 0;
            font-size: 16px;
            font-weight: 500;
            letter-spacing: -0.32px;
            line-height: 1.2;
            color: #C3C3C8;
            cursor: pointer;
        }

        .search-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .search-list-item {
            width: 100%;
            border: none;
            border-bottom: 1px solid #ECECF1;
            background: transparent;
            padding: 14px 0;
            text-align: left;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: -0.32px;
            line-height: 1.2;
            color: #000;
            cursor: pointer;
        }

        .search-list-item.no-divider {
            border-bottom: none;
        }

        .search-list-item.static {
            cursor: default;
        }

        .search-list-item:active {
            opacity: 0.72;
        }

        .search-input-wrap {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 10px 16px max(16px, calc(env(safe-area-inset-bottom, 0px) + 8px));
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            z-index: 2601;
        }
        .search-input-wrap::before {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            bottom: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.77) 78%, rgba(255,255,255,0.86) 100%);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            pointer-events: none;
        }

        .search-input-shell {
            height: 52px;
            border-radius: 40px;
            border: 1px solid #fff;
            background: rgba(255,255,255,0.88);
            box-shadow: 0 4px 40px rgba(0,0,0,0.16);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            padding: 0 16px;
            position: relative;
            z-index: 1;
        }

        .search-input-shell svg {
            flex-shrink: 0;
            margin-right: 10px;
        }

        .search-input {
            flex: 1;
            border: none;
            background: transparent;
            outline: none;
            font-family: inherit;
            font-size: 16px;
            font-weight: 400;
            letter-spacing: -0.32px;
            color: #2C2C31;
            caret-color: #007AFF;
        }
        .search-input::-webkit-search-decoration,
        .search-input::-webkit-search-cancel-button,
        .search-input::-webkit-search-results-button,
        .search-input::-webkit-search-results-decoration {
            -webkit-appearance: none;
            appearance: none;
            display: none;
        }

        .search-input::placeholder {
            color: #B0B0B6;
        }

        .search-clear-btn {
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            padding: 0;
            margin-left: 6px;
            cursor: pointer;
            color: #AEAEB2;
        }

        .search-clear-btn.show {
            display: flex;
        }

        .search-products-grid {
            margin-top: 0;
        }

        .search-empty {
            text-align: center;
            padding: 40px 0;
            color: #909096;
            font-size: 17px;
        }

        /* ===== Pages ===== */
        .page {
            display: none;
            min-height: 100vh;
            padding: 16px;
            padding-bottom: 108px;
        }

        .page.active { display: block; }

        .page-no-filters {
            padding-top: 0;
        }

        .page-title {
            font-size: 22px;
            font-weight: 600;
            font-style: normal;
            color: #000;
            letter-spacing: -0.5px;
            margin-bottom: 16px;
        }

        /* Requested page title style: Favorites, Cart, Order History, Order Details, Viewed Products */
        #favoritesPage > .page-title,
        #cartPage .cart-page-title,
        #profileOrdersView > .page-title,
        #profileOrderDetailView > .page-title,
        #profileViewedView > .page-title {
            font-style: normal;
            font-size: 20px;
            font-weight: 590;
            line-height: 120%;
            letter-spacing: -0.03em;
        }

        .page-header {
            position: sticky;
            top: 0;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 12px 16px;
            margin: -16px -16px 16px;
            border-bottom: 1px solid #E5E7EB;
            z-index: 100;
            text-align: center;
        }

        .page-header h2 {
            font-size: 20px;
            font-weight: 700;
        }

        /* ===== Product Detail Modal ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 2000;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-content {
            padding-bottom: calc(68px + max(12px, env(safe-area-inset-bottom, 12px)));
            padding-top: calc(var(--sys-safe-top, env(safe-area-inset-top, 0px)) + var(--tg-header-height, 44px));
        }

        /* Nav-bar detail mode elements */
        .nav-back-btn {
            display: none;
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #E5E7EB;
            background: #fff;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .nav-back-icon {
            width: 18px;
            height: 18px;
        }

        .nav-back-icon-close {
            display: none;
            width: 16px;
            height: 16px;
        }

        .nav-actions-right {
            display: none;
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            align-items: center;
            gap: 0;
            background: #fff;
            border: 1px solid #E5E7EB;
            border-radius: 20px;
            padding: 6px 4px;
            z-index: 10;
        }

        .nav-action-btn {
            width: 28px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .nav-actions-divider {
            width: 1px;
            height: 16px;
            background: #E5E7EB;
        }

        body.detail-mode .filters-wrap { display: none !important; }
        body.detail-mode .tab-bar-wrap { display: none !important; }
        body.detail-mode .nav-bar {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        body.viewer-mode .tab-bar-wrap { display: none !important; }
        body.viewer-mode .detail-bottom-bar { display: none !important; }
        body.viewer-mode .nav-actions-right { display: none !important; }
        body.viewer-mode .nav-back-btn { display: flex !important; }
        body.viewer-mode .nav-close-btn { display: none !important; }
        body.viewer-mode .nav-bar {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        body.search-mode .tab-bar-wrap { display: none !important; }
        body.search-mode .nav-back-btn { display: none !important; }
        body.search-mode .nav-actions-right { display: none !important; }
        body.search-mode .nav-bar {
            background: transparent;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }
        body.search-mode .nav-bar::before {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 30px;
            background: linear-gradient(180deg, rgba(255,255,255,0.86) 0%, rgba(255,255,255,0.77) 80%, rgba(255,255,255,0) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            pointer-events: none;
        }
        body.search-mode .nav-header,
        body.search-mode .filters-wrap {
            position: relative;
            z-index: 1;
        }

        /* Detail gallery */
        .detail-gallery {
            position: relative;
            margin-top: 16px;
        }

        .detail-images {
            display: flex;
            gap: 8px;
            padding-left: 16px;
            overflow-x: auto;
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }

        .detail-images::after {
            content: '';
            flex-shrink: 0;
            width: 8px;
        }

        .detail-images::-webkit-scrollbar {
            display: none;
        }

        .detail-images.single {
            padding: 0;
            justify-content: center;
        }

        .detail-images.single::after {
            display: none;
        }

        .detail-image-wrap {
            position: relative;
            flex-shrink: 0;
            width: 314px;
            height: 410px;
        }

        .detail-image {
            width: 314px;
            height: 410px;
            border-radius: 20px;
            background: #F5F5F5;
            object-fit: cover;
            cursor: pointer;
            display: block;
        }

        .detail-gallery-actions {
            position: absolute;
            top: -6px;
            right: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 8;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            width: 80px;
            height: 40px;
            box-sizing: border-box;
            border-radius: 40px;
            border: 1px solid #FFFFFF;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            padding: 4px;
        }

        .detail-img-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .detail-img-btn img {
            width: 20px;
            height: 20px;
            opacity: 0.45;
            transition: opacity 0.2s;
        }

        #detailFavBtn.fav-active img {
            opacity: 1;
        }

        /* Volume selector */
        .volume-selector {
            display: flex;
            gap: 4px;
            padding: 4px;
            margin: 16px 16px 0;
            background: #FFFFFF;
            border: 1px solid #E5E5EA;
            border-radius: 100px;
            width: fit-content;
        }

        .volume-btn {
            height: 40px;
            padding: 0 22px;
            border-radius: 100px;
            border: none;
            font-family: inherit;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            background: #FFFFFF;
            color: #8E8E93;
        }

        .volume-btn.active {
            background: #007AFF;
            color: #fff;
        }

        /* Detail brand + title */
        .detail-brand-line {
            padding: 16px 16px 0;
            font-size: 15px;
            font-weight: 400;
            color: #000;
            letter-spacing: -0.3px;
        }

        .detail-brand-line .brand-name {
            font-weight: 600;
            text-transform: uppercase;
        }

        .detail-brand-line .brand-sep {
            color: #909096;
            margin: 0 4px;
        }

        /* Detail price */
        .detail-price-row {
            display: flex;
            align-items: baseline;
            gap: 10px;
            padding: 8px 16px 0;
        }

        .detail-price {
            font-size: 22px;
            font-weight: 700;
            color: #000;
            letter-spacing: -0.5px;
        }

        .detail-old-price {
            font-size: 16px;
            color: #909096;
            text-decoration: line-through;
        }

        /* Description card */
        .detail-desc-card {
            margin: 16px 16px 0;
            background: #F6F6F6;
            border-radius: 16px;
            padding: 20px;
        }

        .detail-desc-card h3 {
            font-size: 18px;
            font-weight: 590;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.72px;
            margin-bottom: 12px;
            color: #000;
        }

        .detail-desc-text {
            font-size: 14px;
            font-weight: 400;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.56px;
            color: #3C3C43;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .detail-desc-text.collapsed {
            max-height: calc(8 * 1.2em);
        }

        .detail-desc-toggle {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
            font-size: 14px;
            font-weight: 400;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.56px;
            color: #909096;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            font-family: inherit;
        }

        .detail-desc-toggle svg {
            transition: transform 0.2s;
        }

        .detail-desc-toggle.expanded svg {
            transform: rotate(180deg);
        }

        /* Specs card */
        .detail-specs-card {
            margin: 16px 16px 16px;
            background: #F6F6F6;
            border-radius: 16px;
            padding: 20px;
        }

        .detail-specs-card h3 {
            font-size: 18px;
            font-weight: 590;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.72px;
            margin-bottom: 16px;
            color: #000;
        }

        .spec-row {
            display: grid;
            grid-template-columns: minmax(120px, 44%) 1fr;
            column-gap: 12px;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid #E8E8ED;
        }

        .spec-row:first-of-type {
            padding-top: 0;
        }

        .spec-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .spec-label {
            font-size: 14px;
            font-weight: 400;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.56px;
            color: #909096;
            flex-shrink: 0;
        }

        .spec-value {
            font-size: 14px;
            font-weight: 400;
            font-style: normal;
            line-height: 120%;
            letter-spacing: -0.56px;
            color: #000;
            text-align: left;
        }

        /* Detail bottom bar */
        .detail-bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            padding: 12px 16px;
            padding-bottom: max(12px, env(safe-area-inset-bottom, 12px));
            z-index: 3002;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .detail-add-btn {
            flex: 1;
            height: 52px;
            border-radius: 51px;
            border: none;
            background: #007AFF;
            color: #fff;
            font-family: inherit;
            font-size: 16px;
            font-weight: 510;
            cursor: pointer;
            letter-spacing: -0.64px;
        }

        .detail-qty-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            background: #FFFFFF;
            border-radius: 51px;
            padding: 0 16px;
            height: 52px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.10);
        }

        .detail-qty-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            font-weight: 500;
            color: #000;
            padding: 0;
        }

        .detail-qty-value {
            font-size: 16px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .detail-goto-cart-btn {
            flex: 1;
            height: 52px;
            border-radius: 51px;
            border: none;
            background: #007AFF;
            color: #fff;
            font-family: inherit;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            letter-spacing: -0.3px;
        }

        /* Image viewer fullscreen */
        .image-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 2500;
            flex-direction: column;
        }

        .image-viewer.show {
            display: flex;
        }

        .image-viewer-main {
            flex: 1;
            position: relative;
            overflow: hidden;
            padding-top: calc(var(--sys-safe-top, env(safe-area-inset-top, 0px)) + var(--tg-header-height, 44px) + 48px);
            touch-action: pan-y;
            background: #F5F5F5;
        }

        .viewer-track {
            height: 100%;
            display: flex;
            will-change: transform;
        }

        .viewer-slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
            box-sizing: border-box;
        }

        .viewer-slide img {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
        }

        .image-viewer-thumbs {
            display: flex;
            align-items: center;
            gap: 10px;
            height: 185px;
            box-sizing: border-box;
            padding: 24px 16px;
            overflow-x: auto;
            scrollbar-width: none;
            background: #fff;
        }

        .image-viewer-thumbs::-webkit-scrollbar { display: none; }

        .viewer-thumb {
            width: 52px;
            height: 72px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            cursor: pointer;
            border: none;
            background: #F5F5F5;
            transition: transform 0.2s ease;
        }

        .viewer-thumb.active {
            transform: scale(1.24);
        }

        .viewer-thumb img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .nav-close-btn {
            display: none;
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #E5E7EB;
            background: #fff;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .nav-close-btn svg {
            width: 16px;
            height: 16px;
        }

        .btn-primary {
            flex: 1;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ===== Cart ===== */
        .cart-page {
            padding-bottom: 128px;
        }

        .cart-page.has-items {
            padding-bottom: 230px;
        }

        .cart-head-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .cart-page-title {
            margin-bottom: 0;
        }

        .cart-head-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cart-head-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            color: #C2C2C9;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            padding: 0;
        }

        .cart-head-btn img {
            width: 20px;
            height: 20px;
            opacity: 0.45;
        }

        .cart-head-btn svg {
            width: 20px;
            height: 20px;
        }

        .cart-master-check,
        .cart-item-check {
            width: 24px;
            height: 24px;
            border-radius: 7px;
            border: 2px solid #D8D8DE;
            background: #fff;
            position: relative;
            flex-shrink: 0;
            cursor: pointer;
        }

        .cart-master-check.checked,
        .cart-item-check.checked {
            background: #007AFF;
            border-color: #007AFF;
        }

        .cart-master-check.checked::after,
        .cart-item-check.checked::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 2px;
            width: 5px;
            height: 11px;
            border: solid #fff;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        #cartItems {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .cart-card {
            display: flex;
            gap: 12px;
            padding: 12px;
            height: 150px;
            border-radius: 20px;
            background: #F6F6F7;
        }

        .cart-card-image-wrap {
            width: 102px;
            height: 126px;
            border-radius: 12px;
            background: #EFEFF1;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .cart-card-image {
            width: auto;
            height: 126px;
            max-width: 100%;
            border-radius: 12px;
            object-fit: contain;
        }

        .cart-card-main {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .cart-card-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 8px;
        }

        .cart-card-title {
            font-size: 16px;
            font-weight: 400;
            letter-spacing: -0.32px;
            line-height: 1.2;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .cart-card-volume {
            margin-top: 6px;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: -0.3px;
            line-height: 1.15;
            color: #A4A4AA;
        }

        .cart-card-bottom {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 10px;
            margin-top: 8px;
        }

        .cart-qty {
            height: 40px;
            border-radius: 20px;
            background: #fff;
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 0 14px;
            flex-shrink: 0;
        }

        .cart-qty-btn {
            width: 14px;
            height: 14px;
            border: none;
            background: transparent;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            line-height: 1;
            color: #000;
            cursor: pointer;
        }

        .cart-qty-value {
            min-width: 14px;
            text-align: center;
            font-size: 17px;
            font-weight: 510;
            letter-spacing: -0.34px;
            line-height: 1.1;
            color: #141414;
        }

        .cart-price-col {
            text-align: right;
            white-space: nowrap;
        }

        .cart-old-price {
            font-size: 13px;
            font-weight: 400;
            letter-spacing: -0.2px;
            line-height: 1.15;
            color: #A3A3AA;
            text-decoration: line-through;
            margin-bottom: 3px;
        }

        .cart-now-price {
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
            line-height: 1.15;
            color: #000;
        }

        .cart-empty {
            text-align: center;
            color: #A8A8AE;
            padding-top: 126px;
        }

        .cart-empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 18px;
            opacity: 0.25;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cart-empty-icon img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        #emptyFavorites .cart-empty-icon img {
            filter: brightness(0);
        }

        .cart-empty-text {
            font-size: 16px;
            font-weight: 500;
            letter-spacing: -0.3px;
            line-height: 1.24;
        }

        .cart-empty-btn {
            margin-top: 18px;
            height: 44px;
            padding: 0 28px;
            border-radius: 22px;
            border: none;
            background: #E3E3E6;
            color: #98989E;
            font-family: inherit;
            font-size: 15px;
            font-weight: 510;
            letter-spacing: -0.3px;
            cursor: pointer;
        }

        .cart-offer {
            margin-top: 20px;
            padding: 18px 16px;
            border-radius: 20px;
            border: 1px solid #D7D7DD;
            text-align: center;
            background: #fff;
        }

        .cart-offer-title {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.34px;
            line-height: 1.1;
            color: #1A1A1D;
        }

        .cart-offer-desc {
            margin-top: 8px;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: -0.28px;
            line-height: 1.22;
            color: #8E8E95;
        }

        .cart-offer-btn {
            margin-top: 14px;
            height: 44px;
            padding: 0 30px;
            border-radius: 24px;
            border: none;
            background: linear-gradient(90deg, #B252FF 0%, #F09919 100%);
            color: #fff;
            font-family: inherit;
            font-size: 17px;
            font-weight: 590;
            letter-spacing: -0.34px;
            cursor: pointer;
        }

        .cart-bottom-action {
            position: fixed;
            left: 16px;
            right: 16px;
            bottom: calc(max(92px, env(safe-area-inset-bottom, 0px) + 72px));
            height: 52px;
            border-radius: 26px;
            border: none;
            padding: 0 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-family: inherit;
            cursor: pointer;
            z-index: 1200;
            background: #007AFF;
            color: #fff;
        }

        .cart-bottom-action.disabled {
            background: #D8D8DB;
            color: #AFAFB4;
            justify-content: center;
            cursor: default;
        }

        .cart-bottom-count,
        .cart-bottom-cta {
            font-size: 16px;
            font-weight: 600;
            letter-spacing: -0.3px;
            line-height: 1.2;
        }

        .cart-bottom-total {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            line-height: 1.1;
        }

        .cart-bottom-total-main {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.34px;
        }

        .cart-bottom-total-old {
            font-size: 12px;
            font-weight: 400;
            letter-spacing: -0.2px;
            opacity: 0.68;
            text-decoration: line-through;
            margin-top: 2px;
        }

        .cart-sheet-overlay {
            display: none;
            position: fixed;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.58);
            z-index: 3600;
        }

        .cart-sheet-overlay.show {
            display: block;
        }

        .cart-sheet {
            display: none;
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            border-radius: 20px 20px 0 0;
            z-index: 3610;
            padding: 8px 16px max(18px, env(safe-area-inset-bottom, 18px));
        }

        .cart-sheet.show {
            display: block;
        }

        .cart-sheet-handle {
            width: 36px;
            height: 4px;
            border-radius: 4px;
            background: #E5E5EA;
            margin: 0 auto 20px;
        }

        .cart-delete-title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.34px;
            line-height: 1.2;
            margin-bottom: 20px;
        }

        .cart-sheet-actions {
            display: flex;
            gap: 8px;
        }

        .cart-sheet-btn {
            flex: 1;
            height: 52px;
            border-radius: 26px;
            border: none;
            font-family: inherit;
            font-size: 17px;
            font-weight: 590;
            letter-spacing: -0.34px;
            cursor: pointer;
        }

        .cart-sheet-btn.secondary {
            background: #E3E3E6;
            color: #6F6F76;
        }

        .cart-sheet-btn.primary {
            background: #007AFF;
            color: #fff;
        }

        .cart-share-title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.34px;
            line-height: 1.15;
            margin-bottom: 14px;
            color: #1A1A1D;
        }

        .cart-share-subtitle {
            font-size: 15px;
            font-weight: 400;
            color: #8E8E95;
            line-height: 1.2;
        }

        .cart-share-count {
            margin-top: 2px;
            font-size: 17px;
            font-weight: 600;
            line-height: 1.2;
            color: #1A1A1D;
        }

        .cart-share-divider {
            height: 1px;
            background: #E8E8EC;
            margin: 16px 0;
        }

        .cart-share-options {
            display: flex;
            justify-content: space-between;
            gap: 8px;
        }

        .cart-share-option {
            width: 76px;
            border: none;
            background: transparent;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-family: inherit;
        }

        .cart-share-icon {
            width: 58px;
            height: 58px;
            border-radius: 29px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
        }

        .cart-share-option-label {
            font-size: 13px;
            font-weight: 400;
            letter-spacing: -0.2px;
            line-height: 1.2;
            color: #2B2B2F;
            text-align: center;
        }

        .cart-share-copy { background: #EFEFF1; color: #333; }
        .cart-share-tg { background: #4EA8FF; color: #fff; }
        .cart-share-wa { background: #41C95A; color: #fff; }
        .cart-share-more { background: #EFEFF1; color: #333; }

        /* ===== Profile ===== */
        .profile-view {
            display: none;
        }

        .profile-view.active {
            display: block;
        }

        .profile-home-top {
            padding: 10px 0 12px;
            text-align: center;
        }

        .avatar {
            width: 108px;
            height: 108px;
            border-radius: 50%;
            background: linear-gradient(180deg, #9EDD7D 0%, #55CB68 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            font-weight: 500;
            color: #fff;
            margin: 0 auto 14px;
            overflow: hidden;
        }

        .profile-name {
            font-size: 30px;
            font-weight: 600;
            letter-spacing: -0.7px;
            line-height: 1.1;
            color: #1A1A1D;
        }

        .profile-phone {
            margin-top: 6px;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.2;
            color: #8E8E95;
        }

        .profile-home-shortcut-btn {
            width: 100%;
            min-height: 38px;
            border: 1px solid #D6D6DB;
            border-radius: 20px;
            background: transparent;
            color: #66666F;
            font-size: 16px;
            font-weight: 510;
            letter-spacing: -0.35px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
        }

        .profile-home-shortcut-icon {
            width: 18px;
            height: 18px;
            border: 1.4px solid #9999A1;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
        }

        .profile-home-shortcut-note {
            margin: 8px 10px 18px;
            font-size: 14px;
            font-weight: 400;
            letter-spacing: -0.15px;
            line-height: 1.25;
            color: #9D9DA5;
            text-align: center;
        }

        .profile-menu-group {
            background: #F2F2F4;
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .profile-menu-item {
            width: 100%;
            border: none;
            background: transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 14px;
            color: #222328;
            cursor: pointer;
            font-family: inherit;
            font-style: normal;
            font-size: 16px;
            font-weight: 400;
            line-height: 120%;
            letter-spacing: -0.64px;
            text-align: left;
        }

        .profile-menu-item + .profile-menu-item {
            border-top: 1px solid #DFDFE4;
        }

        .profile-menu-icon {
            width: 28px;
            height: 28px;
            border-radius: 7px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .profile-menu-icon.orders { background: #FF2D55; }
        .profile-menu-icon.viewed { background: #0A84FF; }
        .profile-menu-icon.support { background: #34C759; }
        .profile-menu-icon.loyalty { background: #FF9F0A; }
        .profile-menu-icon.invite { background: #32ADE6; }
        .profile-menu-icon.rules { background: #B0B0B5; }
        .profile-menu-icon.policy { background: #AEAEB2; }

        .profile-menu-chevron {
            margin-left: auto;
            color: #9A9AA2;
            font-size: 18px;
            line-height: 1;
        }

        .profile-orders-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-order-card {
            border-radius: 16px;
            background: #F2F2F4;
            padding: 14px;
            cursor: pointer;
        }

        .profile-order-top {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .profile-order-status {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .profile-order-status.shipped { color: #007AFF; }
        .profile-order-status.delivered { color: #1F1F23; }
        .profile-order-status.cancelled { color: #8E8E95; }

        .profile-order-grid {
            border-top: 1px solid #DFDFE4;
        }

        .profile-order-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #DFDFE4;
            padding: 8px 0;
        }

        .profile-order-row:last-child {
            border-bottom: none;
        }

        .profile-order-key {
            color: #8E8E95;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: -0.18px;
        }

        .profile-order-value {
            color: #202026;
            font-size: 15px;
            font-weight: 500;
            letter-spacing: -0.18px;
            text-align: right;
        }

        .profile-order-thumbs {
            display: flex;
            gap: 8px;
            margin: 12px 0;
        }

        .profile-order-thumb {
            width: 66px;
            height: 86px;
            border-radius: 10px;
            background: #fff;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-order-thumb img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .profile-order-action {
            width: 100%;
            border: none;
            border-radius: 20px;
            height: 38px;
            font-family: inherit;
            font-size: 16px;
            font-weight: 510;
            letter-spacing: -0.33px;
            cursor: pointer;
        }

        .profile-order-action.track {
            background: #007AFF;
            color: #fff;
        }

        .profile-order-action.repeat {
            background: #DEDEE2;
            color: #8C8C94;
        }

        .profile-detail-card {
            border-radius: 16px;
            background: #F2F2F4;
            padding: 12px;
            margin-bottom: 12px;
        }

        .profile-detail-card-title {
            margin-bottom: 8px;
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.3px;
            color: #1F1F24;
        }

        .profile-detail-row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid #DFDFE4;
            padding: 7px 0;
        }

        .profile-detail-row:last-child {
            border-bottom: none;
        }

        .profile-detail-key {
            color: #8E8E95;
            font-size: 15px;
            font-weight: 400;
            letter-spacing: -0.18px;
        }

        .profile-detail-value {
            color: #202026;
            font-size: 15px;
            font-weight: 510;
            letter-spacing: -0.18px;
            text-align: right;
            white-space: pre-line;
        }

        .profile-detail-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 14px 0 10px;
        }

        .profile-detail-section-title {
            font-size: 17px;
            font-weight: 600;
            letter-spacing: -0.3px;
            color: #1F1F24;
        }

        .profile-detail-section-meta {
            font-size: 14px;
            font-weight: 500;
            letter-spacing: -0.14px;
            color: #8E8E95;
        }

        .profile-detail-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }

        .profile-detail-item {
            background: #F2F2F4;
            border-radius: 16px;
            padding: 10px;
            display: flex;
            gap: 10px;
        }

        .profile-detail-item-image {
            width: 62px;
            height: 82px;
            border-radius: 10px;
            background: #fff;
            overflow: hidden;
            flex-shrink: 0;
        }

        .profile-detail-item-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .profile-detail-item-title {
            font-size: 15px;
            font-weight: 500;
            letter-spacing: -0.2px;
            color: #1E1E22;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .profile-detail-item-meta {
            font-size: 14px;
            font-weight: 400;
            color: #8E8E95;
            line-height: 1.25;
            letter-spacing: -0.1px;
        }

        .profile-detail-item-price {
            margin-top: 4px;
            font-size: 15px;
            font-weight: 600;
            letter-spacing: -0.15px;
            color: #1E1E22;
        }

        .profile-viewed-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 16px 8px;
        }

        .profile-viewed-card {
            cursor: pointer;
        }

        .profile-viewed-image-wrap {
            width: 100%;
            aspect-ratio: 168 / 220;
            border-radius: 18px;
            background: #F2F2F4;
            position: relative;
            overflow: hidden;
        }

        .profile-viewed-image-wrap img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .profile-viewed-fav {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            cursor: pointer;
            color: #B5B5BC;
            padding: 0;
        }

        .profile-viewed-fav.active {
            color: #EB4444;
        }

        .profile-viewed-dots {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            margin: 4px 0 6px;
        }

        .profile-viewed-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #BDBDC4;
        }

        .profile-viewed-dot.active {
            background: #75757F;
        }

        .profile-viewed-prices {
            display: flex;
            align-items: baseline;
            gap: 6px;
            margin-bottom: 2px;
        }

        .profile-viewed-price {
            font-size: 15px;
            font-weight: 590;
            letter-spacing: -0.22px;
            color: #1E1E22;
        }

        .profile-viewed-old {
            font-size: 14px;
            font-weight: 400;
            letter-spacing: -0.14px;
            color: #9A9AA2;
            text-decoration: line-through;
        }

        .profile-viewed-title {
            font-size: 14px;
            font-weight: 400;
            letter-spacing: -0.2px;
            line-height: 1.2;
            color: #1E1E22;
        }

        .profile-doc-wrap {
            border-radius: 16px;
            overflow: hidden;
            background: #F2F2F4;
            border: 1px solid #E4E4E9;
            height: calc(100vh - var(--content-top-no-filters, 96px) - 170px);
            min-height: 420px;
        }

        .profile-doc-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        .profile-popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.32);
            z-index: 3500;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .profile-popup-overlay.show {
            display: flex;
        }

        .profile-popup {
            width: min(420px, 100%);
            background: #fff;
            border-radius: 18px;
            padding: 18px 16px 20px;
            position: relative;
            box-shadow: 0 14px 36px rgba(0, 0, 0, 0.2);
        }

        .profile-popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 15px;
            background: #EFEFF3;
            color: #707078;
            font-size: 20px;
            line-height: 1;
            cursor: pointer;
            font-family: inherit;
        }

        .profile-popup-title {
            font-size: 20px;
            font-weight: 600;
            letter-spacing: -0.3px;
            color: #1E1E22;
            padding-right: 40px;
        }

        .profile-popup-text {
            margin-top: 10px;
            font-size: 17px;
            font-weight: 400;
            letter-spacing: -0.18px;
            line-height: 1.3;
            color: #62626A;
        }

        /* ===== Forms ===== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #000;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus { border-color: var(--primary); }

        .checkout-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary), #7C3AED);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 24px;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        /* ===== Loading & Success ===== */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 5000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #E5E7EB;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .success-screen {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #fff;
            z-index: 5000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: var(--success);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            color: white;
            margin-bottom: 24px;
            animation: scaleIn 0.5s;
        }

        @keyframes scaleIn {
            from { transform: scale(0); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6B7280;
        }

        .empty-icon {
            margin-bottom: 16px;
            opacity: 0.35;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<!-- ===== Navigation Bar ===== -->
<div class="nav-bar">
    <div class="nav-header">
        <!-- Back button (detail mode) -->
        <button class="nav-back-btn" onclick="handleNavBack()">
            <svg class="nav-back-icon nav-back-icon-arrow" viewBox="0 0 18 18" fill="none"><path d="M11 4L6 9L11 14" stroke="#000" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <svg class="nav-back-icon nav-back-icon-close" viewBox="0 0 16 16" fill="none"><path d="M3 3L13 13M13 3L3 13" stroke="#000" stroke-width="1.8" stroke-linecap="round"/></svg>
        </button>
        <!-- Close button (viewer mode) -->
        <button class="nav-close-btn" onclick="closeImageViewer()">
            <svg viewBox="0 0 16 16" fill="none"><path d="M2 2L14 14M14 2L2 14" stroke="#000" stroke-width="1.8" stroke-linecap="round"/></svg>
        </button>
        <img src="logo.png" alt="Ароматная Публика" class="nav-logo-img">
        <!-- Right action buttons (detail mode) -->
        <div class="nav-actions-right">
            <button class="nav-action-btn" onclick="handleHeaderPrimaryAction()"><svg width="14" height="8" viewBox="0 0 14 8" fill="none"><path d="M1 1L7 7L13 1" stroke="#000" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            <div class="nav-actions-divider"></div>
            <button class="nav-action-btn" onclick="showDetailMenu()"><svg width="16" height="4" viewBox="0 0 16 4" fill="none"><circle cx="2" cy="2" r="1.5" fill="#000"/><circle cx="8" cy="2" r="1.5" fill="#000"/><circle cx="14" cy="2" r="1.5" fill="#000"/></svg></button>
        </div>
    </div>
    <div class="filters-wrap">
        <div class="filters">
            <button class="filter-btn icon-only" id="sortBtn" onclick="showSortSheet()">
                <img src="icon/sort.svg" width="20" height="20" alt="сортировка">
            </button>
            <button class="filter-btn with-icon" id="brandBtn" onclick="showBrandSheet()">
                <span id="brandBtnText">Бренд</span>
                <svg width="10" height="6" viewBox="0 0 10 6" fill="none" style="margin-left:2px"><path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span class="brand-badge hidden" id="brandBadge">0</span>
            </button>
            <button class="filter-btn" data-category="women" onclick="toggleCategory('women', this)">Женские</button>
            <button class="filter-btn" data-category="men" onclick="toggleCategory('men', this)">Мужские</button>
            <button class="filter-btn" data-category="unisex" onclick="toggleCategory('unisex', this)">Унисекс</button>
        </div>
    </div>
</div>

<!-- Sort Bottom Sheet -->
<div class="sort-overlay" id="sortOverlay" onclick="closeSortSheet()"></div>
<div class="sort-sheet" id="sortSheet">
    <div class="sort-sheet-handle"></div>
    <div class="sort-sheet-title">Показать сначала</div>
    <div class="sort-sheet-options" id="sortOptions">
        <label class="sort-sheet-option">
            <span>Популярные</span>
            <input type="radio" name="sort" value="popular" checked>
            <span class="sort-radio"></span>
        </label>
        <label class="sort-sheet-option">
            <span>Подешевле</span>
            <input type="radio" name="sort" value="price-asc">
            <span class="sort-radio"></span>
        </label>
        <label class="sort-sheet-option">
            <span>Подороже</span>
            <input type="radio" name="sort" value="price-desc">
            <span class="sort-radio"></span>
        </label>
    </div>
    <div class="sort-sheet-buttons">
        <button class="sort-btn-cancel" onclick="cancelSort()">Отменить</button>
        <button class="sort-btn-apply" onclick="applySort()">Применить</button>
    </div>
</div>

<!-- Brand Bottom Sheet -->
<div class="sort-overlay" id="brandOverlay" onclick="closeBrandSheet()"></div>
<div class="sort-sheet brand-sheet" id="brandSheet">
    <div class="sort-sheet-handle"></div>
    <div class="sort-sheet-title">Показать бренды</div>
    <div class="brand-sheet-options" id="brandOptions"></div>
    <div class="sort-sheet-buttons">
        <button class="sort-btn-cancel" onclick="cancelBrands()">Отменить</button>
        <button class="sort-btn-apply" onclick="applyBrands()">Применить</button>
    </div>
</div>

<!-- ===== Main Content ===== -->
<div class="content">

    <!-- Main Page -->
    <div id="mainPage" class="page active">
        <!-- Banner -->
        <div class="banner-section">
            <div class="banner-carousel" id="bannerCarousel">
                <div class="banner-slides" id="bannerSlides">
                    <div class="banner-slide"><img src="banner.png" style="width:100%;height:100%;object-fit:cover;"></div>
                    <div class="banner-slide"><img src="banner.png" style="width:100%;height:100%;object-fit:cover;"></div>
                    <div class="banner-slide"><img src="banner.png" style="width:100%;height:100%;object-fit:cover;"></div>
                </div>
            </div>
            <div class="pagination" id="bannerDots"></div>
        </div>

        <!-- Collections -->
        <div class="collections" id="collections">
            <div class="collection" onclick="filterByTag('summer')">
                <div class="collection-img"><img src="sale.png" alt="Летние"></div>
                <div class="collection-name">Летние</div>
            </div>
            <div class="collection" onclick="filterByTag('spring')">
                <div class="collection-img"><img src="sale.png" alt="Весенние"></div>
                <div class="collection-name">Весенние</div>
            </div>
            <div class="collection" onclick="filterByTag('new')">
                <div class="collection-img"><img src="sale.png" alt="Новинки"></div>
                <div class="collection-name">Новинки 2026</div>
            </div>
            <div class="collection" onclick="filterByTag('gift')">
                <div class="collection-img"><img src="sale.png" alt="Подарки"></div>
                <div class="collection-name">Подарки</div>
            </div>
        </div>

        <!-- Brand Name Label -->
        <div class="brand-label hidden" id="brandLabel"></div>

        <!-- Products -->
        <div class="products-section">
            <div class="products" id="productsGrid"></div>
        </div>

        <div id="searchOverlay" class="search-overlay">
            <div class="search-scroll" id="searchScroll">
                <div id="searchContent"></div>
            </div>
            <div class="search-input-wrap">
                <div class="search-input-shell">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <circle cx="8.5" cy="8.5" r="6" stroke="#A8A8AE" stroke-width="1.5"/>
                        <path d="M13 13L17.5 17.5" stroke="#A8A8AE" stroke-width="1.5" stroke-linecap="round"/>
                    </svg>
                    <input id="searchInput" class="search-input" type="search" placeholder="Поиск" autocomplete="off" autocapitalize="none" spellcheck="false">
                    <button id="searchClearBtn" class="search-clear-btn" onclick="clearSearchQuery()">
                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                            <path d="M4.5 4.5L13.5 13.5M13.5 4.5L4.5 13.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Favorites Page -->
    <div id="favoritesPage" class="page page-no-filters">
        <div class="page-title">Избранное</div>
        <div class="products" id="favoritesGrid"></div>
        <div id="emptyFavorites" class="cart-empty hidden">
            <div class="cart-empty-icon">
                <img src="icon/like_big.svg?v=2" alt="">
            </div>
            <p class="cart-empty-text">Собирайте здесь товары,<br>которые вам приглянулись.</p>
            <button class="cart-empty-btn" onclick="showPage('main')">Перейти к товарам</button>
        </div>
    </div>

    <!-- Cart Page -->
    <div id="cartPage" class="page page-no-filters cart-page">
        <div class="cart-head-row">
            <div class="page-title cart-page-title">Корзина</div>
            <div id="cartHeadActions" class="cart-head-actions hidden">
                <button class="cart-head-btn" onclick="showCartShareSheet()">
                    <img src="icon/share.svg" width="20" height="20" alt="Поделиться">
                </button>
                <button class="cart-head-btn" onclick="showCartClearSheet()">
                    <img src="icon/delete.svg" width="20" height="20" alt="Удалить">
                </button>
                <button id="cartSelectAllBtn" class="cart-master-check" onclick="toggleCartSelectAll()"></button>
            </div>
        </div>

        <div id="cartItems"></div>

        <div id="emptyCart" class="cart-empty hidden">
            <div class="cart-empty-icon">
                <img src="icon/cart.svg" alt="">
            </div>
            <p class="cart-empty-text">В корзине пока пусто, начните<br>покупки прямо сейчас.</p>
            <button class="cart-empty-btn" onclick="showPage('main')">Перейти к товарам</button>
        </div>

        <div id="cartOffer" class="cart-offer hidden">
            <div class="cart-offer-title">Скидка 2000 ₽ за еще один товар</div>
            <div class="cart-offer-desc">Добавь в корзину еще один любой товар и получи скидку на заказ.</div>
            <button class="cart-offer-btn" onclick="showPage('main')">Товары со скидками</button>
        </div>

        <button id="cartBottomAction" class="cart-bottom-action hidden" onclick="handleCartBottomAction()"></button>
    </div>

    <!-- Profile Page -->
    <div id="profilePage" class="page page-no-filters">
        <div id="profileHomeView" class="profile-view active">
            <div class="profile-home-top">
                <div class="avatar" id="userAvatar">Г</div>
                <div class="profile-name" id="userName">Гость</div>
                <div class="profile-phone" id="userPhone">Войдите через Telegram</div>
            </div>

            <button class="profile-home-shortcut-btn" onclick="handleAddToHomeScreen()">
                <span class="profile-home-shortcut-icon">+</span>
                Добавить на экран «Домой»
            </button>
            <p class="profile-home-shortcut-note">Добавьте иконку магазина на главный экран смартфона, чтобы он всегда был под рукой.</p>

            <div class="profile-menu-group">
                <button class="profile-menu-item" onclick="openProfileOrders()">
                    <span class="profile-menu-icon orders">O</span>
                    <span>История заказов</span>
                    <span class="profile-menu-chevron">›</span>
                </button>
                <button class="profile-menu-item" onclick="openProfileViewed()">
                    <span class="profile-menu-icon viewed">V</span>
                    <span>Просмотренные товары</span>
                    <span class="profile-menu-chevron">›</span>
                </button>
                <button class="profile-menu-item" onclick="showProfilePlaceholder('Поддержка')">
                    <span class="profile-menu-icon support">S</span>
                    <span>Поддержка</span>
                    <span class="profile-menu-chevron">›</span>
                </button>
            </div>

            <div class="profile-menu-group">
                <button class="profile-menu-item" onclick="showProfilePlaceholder('Уровень лояльности')">
                    <span class="profile-menu-icon loyalty">L</span>
                    <span>Уровень лояльности</span>
                    <span class="profile-menu-chevron">›</span>
                </button>
                <button class="profile-menu-item" onclick="showProfilePlaceholder('Пригласить друга')">
                    <span class="profile-menu-icon invite">I</span>
                    <span>Пригласить друга</span>
                    <span class="profile-menu-chevron">›</span>
                </button>
            </div>

            <div class="profile-menu-group">
                <button class="profile-menu-item" onclick="openProfileDocument('rules')">
                    <span class="profile-menu-icon rules">R</span>
                    <span>Условия использования</span>
                    <span class="profile-menu-chevron">›</span>
                </button>
                <button class="profile-menu-item" onclick="openProfileDocument('policy')">
                    <span class="profile-menu-icon policy">P</span>
                    <span>Политика конфиденциальности</span>
                    <span class="profile-menu-chevron">›</span>
                </button>
            </div>
        </div>

        <div id="profileOrdersView" class="profile-view">
            <div class="page-title">История заказов</div>
            <div id="profileOrdersList" class="profile-orders-list"></div>
        </div>

        <div id="profileOrderDetailView" class="profile-view">
            <div class="page-title">Детали заказа</div>
            <div id="profileOrderDetailContent"></div>
        </div>

        <div id="profileViewedView" class="profile-view">
            <div class="page-title">Просмотренные товары</div>
            <div id="profileViewedGrid" class="profile-viewed-grid"></div>
            <div id="profileViewedEmpty" class="empty-state hidden">
                <div class="empty-icon">👀</div>
                <p>Вы еще не смотрели товары</p>
            </div>
        </div>

        <div id="profileDocView" class="profile-view">
            <div id="profileDocTitle" class="page-title">Документ</div>
            <div class="profile-doc-wrap">
                <iframe id="profileDocFrame" class="profile-doc-frame" title="Документ"></iframe>
            </div>
        </div>
    </div>

</div>

<!-- ===== Profile Popup ===== -->
<div id="profilePopupOverlay" class="profile-popup-overlay" onclick="closeProfilePopup()">
    <div class="profile-popup" onclick="event.stopPropagation()">
        <button class="profile-popup-close" onclick="closeProfilePopup()">×</button>
        <div id="profilePopupTitle" class="profile-popup-title">В разработке</div>
        <div id="profilePopupText" class="profile-popup-text">В разработке</div>
    </div>
</div>

<!-- ===== Product Detail Modal ===== -->
<div id="productModal" class="modal">
    <div class="modal-content" id="modalContent"></div>
    <div class="detail-bottom-bar" id="detailBottomBar"></div>
</div>

<!-- ===== Image Viewer ===== -->
<div id="imageViewer" class="image-viewer">
    <div class="image-viewer-main" id="viewerMain"></div>
    <div class="image-viewer-thumbs" id="viewerThumbs"></div>
</div>

<!-- ===== Cart Sheets ===== -->
<div id="cartSheetOverlay" class="cart-sheet-overlay" onclick="closeCartSheets()"></div>

<div id="cartDeleteSheet" class="cart-sheet" onclick="event.stopPropagation()">
    <div class="cart-sheet-handle"></div>
    <div class="cart-delete-title">Удалить все из корзины?</div>
    <div class="cart-sheet-actions">
        <button class="cart-sheet-btn secondary" onclick="closeCartSheets()">Оставить</button>
        <button class="cart-sheet-btn primary" onclick="confirmClearCart()">Удалить</button>
    </div>
</div>

<div id="cartShareSheet" class="cart-sheet" onclick="event.stopPropagation()">
    <div class="cart-sheet-handle"></div>
    <div class="cart-share-title">Поделитесь товарами</div>
    <div class="cart-share-subtitle">В корзине выбрано</div>
    <div id="cartShareCount" class="cart-share-count">0 товаров</div>
    <div class="cart-share-divider"></div>
    <div class="cart-share-options">
        <button class="cart-share-option" onclick="copyCartShareText()">
            <span class="cart-share-icon cart-share-copy">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <rect x="8" y="7" width="10" height="12" rx="2" stroke="currentColor" stroke-width="1.8"/>
                    <path d="M6 15H5C3.9 15 3 14.1 3 13V5C3 3.9 3.9 3 5 3H13C14.1 3 15 3.9 15 5V6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                </svg>
            </span>
            <span class="cart-share-option-label">Копировать<br>ссылку</span>
        </button>
        <button class="cart-share-option" onclick="shareCartViaTelegram()">
            <span class="cart-share-icon cart-share-tg">
                <span style="font-size:22px;line-height:1">✈</span>
            </span>
            <span class="cart-share-option-label">Телеграм</span>
        </button>
        <button class="cart-share-option" onclick="shareCartViaWhatsApp()">
            <span class="cart-share-icon cart-share-wa">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2C6.5 2 2 6.3 2 11.7C2 13.9 2.7 15.9 4 17.6L3 22L7.6 20.8C8.9 21.5 10.4 21.9 12 21.9C17.5 21.9 22 17.6 22 12.2C22 6.8 17.5 2 12 2ZM16.7 14.5C16.5 15 15.3 15.7 14.8 15.8C14.3 16 13.8 16 10.9 14.7C8 13.3 6.8 10.3 6.7 10.1C6.6 9.9 5.5 8.4 5.5 7C5.5 5.6 6.2 4.9 6.5 4.6C6.8 4.3 7.2 4.2 7.4 4.2C7.6 4.2 7.8 4.2 8 4.2C8.2 4.2 8.5 4.1 8.8 4.8C9.1 5.5 9.8 7.2 9.9 7.3C10 7.5 10 7.6 9.9 7.8C9.8 8 9.7 8.1 9.5 8.3C9.3 8.5 9.2 8.6 9 8.8C8.8 9 8.7 9.1 8.9 9.4C9.1 9.7 9.9 11 11.1 12C12.6 13.3 13.8 13.7 14.1 13.8C14.4 13.9 14.6 13.9 14.8 13.7C15 13.5 15.6 12.8 15.8 12.5C16 12.2 16.3 12.2 16.6 12.3C16.9 12.4 18.6 13.2 18.9 13.3C19.2 13.4 19.4 13.5 19.4 13.7C19.4 13.9 19.2 14.2 16.7 14.5Z" fill="currentColor"/>
                </svg>
            </span>
            <span class="cart-share-option-label">WhatsApp</span>
        </button>
        <button class="cart-share-option" onclick="shareCartViaMore()">
            <span class="cart-share-icon cart-share-more">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <circle cx="6" cy="12" r="2" fill="currentColor"/>
                    <circle cx="12" cy="12" r="2" fill="currentColor"/>
                    <circle cx="18" cy="12" r="2" fill="currentColor"/>
                </svg>
            </span>
            <span class="cart-share-option-label">Ещё</span>
        </button>
    </div>
</div>

<!-- ===== Tab Bar ===== -->
<div class="tab-bar-wrap">
    <div class="tab-bar">
        <button class="tab active" onclick="showPage('main')">
            <div class="tab-icon">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M10.0002 2.5L3.3335 7.5V17.5H7.50016V11.6667H12.5002V17.5H16.6668V7.5L10.0002 2.5Z" fill="currentColor"/>
                </svg>
            </div>
            <span class="tab-label">Главная</span>
        </button>

        <button class="tab" onclick="showPage('favorites')">
            <div class="tab-icon">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M9.9974 17.7917L8.78906 16.6917C4.4974 12.8 1.66406 10.2333 1.66406 7.08333C1.66406 4.51667 3.68073 2.5 6.2474 2.5C7.6974 2.5 9.08906 3.175 9.9974 4.24167C10.9057 3.175 12.2974 2.5 13.7474 2.5C16.3141 2.5 18.3307 4.51667 18.3307 7.08333C18.3307 10.2333 15.4974 12.8 11.2057 16.7L9.9974 17.7917Z" fill="currentColor"/>
                </svg>
            </div>
            <span class="tab-badge hidden" id="favBadge">0</span>
            <span class="tab-label">Избранное</span>
        </button>

        <button class="tab" onclick="showPage('cart')">
            <div class="tab-icon">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                    <path d="M15.8333 5.00004H14.1667C14.1667 2.70004 12.3 0.833374 10 0.833374C7.7 0.833374 5.83333 2.70004 5.83333 5.00004H4.16667C3.25 5.00004 2.50833 5.75004 2.50833 6.66671L2.5 16.6667C2.5 17.5834 3.25 18.3334 4.16667 18.3334H15.8333C16.75 18.3334 17.5 17.5834 17.5 16.6667V6.66671C17.5 5.75004 16.75 5.00004 15.8333 5.00004ZM10 2.50004C11.3833 2.50004 12.5 3.61671 12.5 5.00004H7.5C7.5 3.61671 8.61667 2.50004 10 2.50004ZM10 10.8334C7.7 10.8334 5.83333 8.96671 5.83333 6.66671H7.5C7.5 8.05004 8.61667 9.16671 10 9.16671C11.3833 9.16671 12.5 8.05004 12.5 6.66671H14.1667C14.1667 8.96671 12.3 10.8334 10 10.8334Z" fill="currentColor"/>
                </svg>
            </div>
            <span class="tab-badge hidden" id="cartBadge">0</span>
            <span class="tab-label">Корзина</span>
        </button>

        <button class="tab" onclick="showPage('profile')">
            <div class="tab-avatar" id="tabAvatar">
                <span>Г</span>
            </div>
            <span class="tab-label">Профиль</span>
        </button>
    </div>

    <div class="search-btn" onclick="focusSearch()">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <circle cx="8.5" cy="8.5" r="6" stroke="#000" stroke-width="1.3"/>
            <path d="M13 13L17.5 17.5" stroke="#000" stroke-width="1.3" stroke-linecap="round"/>
        </svg>
    </div>
</div>

<!-- Loading -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 16px; color: #6B7280;">Отправляем заказ...</p>
</div>

<!-- Success -->
<div id="successScreen" class="success-screen">
    <div class="success-icon">✓</div>
    <h2 style="font-size: 28px; margin-bottom: 8px;">Заказ принят!</h2>
    <p style="color: #6B7280; margin-bottom: 24px;">Номер: <b id="orderNumber">#0000</b></p>
    <button class="btn-primary" onclick="closeSuccess()" style="width: 200px;">Закрыть</button>
</div>

<script>
    // API URL
    const API_URL = 'https://script.google.com/macros/s/AKfycbznwEQk930Y6N37did0gEjKu2QJmPsPBu-_p1uWALSa2lihR2KBcmgKRKRHVRj4ASIhrg/exec';

    // Telegram WebApp
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    if (tg.disableVerticalSwipes) {
        tg.disableVerticalSwipes();
    }

    function applyPlatformFontClass() {
        const body = document.body;
        if (!body) return;

        const classes = ['platform-ios', 'platform-macos', 'platform-android', 'platform-windows', 'platform-linux'];
        body.classList.remove(...classes);

        const tgPlatform = String(tg.platform || '').toLowerCase();
        const ua = String(navigator.userAgent || '').toLowerCase();
        const navPlatform = String(navigator.platform || '').toLowerCase();

        if (tgPlatform.includes('android') || ua.includes('android')) {
            body.classList.add('platform-android');
            return;
        }

        if (tgPlatform.includes('ios') || /iphone|ipad|ipod/.test(ua)) {
            body.classList.add('platform-ios');
            return;
        }

        if (tgPlatform.includes('macos') || navPlatform.includes('mac')) {
            body.classList.add('platform-macos');
            return;
        }

        if (tgPlatform.includes('linux') || navPlatform.includes('linux') || ua.includes('x11')) {
            body.classList.add('platform-linux');
            return;
        }

        body.classList.add('platform-windows');
    }

    applyPlatformFontClass();

    // Динамически задаём высоту шапки по данным SDK —
    // safeAreaInset.top = высота статусбара устройства,
    // contentSafeAreaInset.top = высота строки с кнопками Телеграма
    function applyNavSafeArea() {
        const sysTop = tg.safeAreaInset?.top ?? 0;
        const tgHeaderH = tg.contentSafeAreaInset?.top ?? 44;
        document.documentElement.style.setProperty('--sys-safe-top', sysTop + 'px');
        document.documentElement.style.setProperty('--tg-header-height', tgHeaderH + 'px');

        // Keep a stable 32px gap from logo bottom to page titles on non-main pages.
        // Logo is 36px tall and vertically centered in nav header.
        const logoBottom = sysTop + ((tgHeaderH - 36) / 2) + 36;
        document.documentElement.style.setProperty('--content-top-no-filters', (logoBottom + 32) + 'px');
    }
    applyNavSafeArea();
    tg.onEvent('safeAreaChanged', applyNavSafeArea);
    tg.onEvent('contentSafeAreaChanged', applyNavSafeArea);
    // Hide Telegram system header by requesting fullscreen
    if (tg.requestFullscreen) {
        tg.requestFullscreen();
    }
    if (tg.setHeaderColor) {
        tg.setHeaderColor('#ffffff');
    }

    // State
    let state = {
        products: [
            {
                sku: 'p001',
                title: 'Amouage Guidance',
                brand: 'Amouage',
                price: 6800,
                oldPrice: 8900,
                category: 'women',
                images: ['Photo_detail.png', 'Photo_detail.png'],
                volumes: ['50 мл', '100 мл'],
                description: 'Роскошный восточный аромат с нотами розы, ладана и ванили. Идеален для особых случаев. В нём ощущаются глубокие нотки ладана и амбры, которые раскрываются постепенно, создавая многогранную композицию.',
                characteristics: {Объем: '50', 'Тип продукта': 'Парфюмерная вода', 'Для кого': 'Для женщин', 'Группа ароматов': 'Восточные, Цветочные', Страна: 'Оман', Парфюмер: 'Renaud Busson', Сегмент: 'Нишевая', Стойкость: 'Стойкий 8-12 ч.'},
                isNew: true,
                popularity: 3,
                tags: ['new', 'spring']
            },
            {
                sku: 'p002',
                title: 'Kilian Paris straight to heaven',
                brand: 'KILIAN',
                price: 10000,
                oldPrice: 10500,
                category: 'men',
                images: ['Photo_detail.png', 'Photo_detail.png', 'Photo_detail.png'],
                volumes: ['50 мл', '100 мл'],
                description: 'Парфюмерная вода By Kilian Straight To Heaven — это красивый благородный запоминающийся аромат. В нем, непременно, присутствуют алкогольные нотки рома, которые открываются для обоняния самыми первыми. В продолжении наслаждения процессом раскрытия Straight To Heaven, ярко ощущаются древесные оттенки, дополненные необычайным сочетанием ванили и пряного пачули. Шлейф парфюмерной воды, который будет повсюду оставаться и напоминать о вашем присутствии, имеет в себе ярко выраженные томные ноты мускуса и серой амбры. By Kilian является мужским ароматом и относится к категории древесных. Несмотря на это, его предпочитает и прекрасная половина.',
                characteristics: {Объем: '50', 'Тип продукта': 'Парфюмерная вода', 'Для кого': 'Для женщин', 'Группа ароматов': 'Древесные, Пряные', Страна: 'Франция', Парфюмер: 'Calice Becker', Сегмент: 'Селективная / Нишевая', Стойкость: 'Стойкий 7-12 ч.'},
                isNew: false,
                popularity: 1,
                tags: ['summer']
            },
            {
                sku: 'p003',
                title: 'NOISE Private Anthem',
                brand: 'NOISE',
                price: 4200,
                category: 'unisex',
                images: ['Photo_detail.png', 'Photo_detail.png'],
                volumes: ['50 мл'],
                description: 'Современный унисекс аромат с цитрусовыми нотами и древесной базой. Свежее открытие переходит в тёплую сердечную ноту с оттенками кедра и ветивера.',
                characteristics: {Объем: '50', 'Тип продукта': 'Парфюмерная вода', 'Для кого': 'Унисекс', 'Группа ароматов': 'Цитрусовые, Древесные', Страна: 'Россия', Парфюмер: 'Алексей Маркин', Сегмент: 'Нишевая', Стойкость: 'Стойкий 6-8 ч.'},
                isNew: true,
                popularity: 4,
                tags: ['new', 'gift']
            },
            {
                sku: 'p004',
                title: 'NISHANE Deziro',
                brand: 'Nishane',
                price: 5800,
                oldPrice: 6500,
                category: 'women',
                images: ['Photo_detail.png', 'Photo_detail.png'],
                volumes: ['50 мл', '100 мл'],
                description: 'Яркий цветочно-фруктовый аромат для уверенных в себе женщин. Сочные ноты персика и малины окружены нежной розой и жасмином.',
                characteristics: {Объем: '50', 'Тип продукта': 'Экстракт духов', 'Для кого': 'Для женщин', 'Группа ароматов': 'Цветочные, Фруктовые', Страна: 'Турция', Парфюмер: 'Jorge Lee', Сегмент: 'Нишевая', Стойкость: 'Стойкий 10-14 ч.'},
                isNew: true,
                popularity: 5,
                tags: ['spring', 'gift']
            },
            {
                sku: 'p005',
                title: 'Chanel No. 5',
                brand: 'Chanel',
                price: 8500,
                category: 'women',
                images: ['Photo_detail.png'],
                volumes: ['50 мл', '100 мл', '200 мл'],
                description: 'Легендарная классика. Цветочно-альдегидный шедевр, который остаётся иконой парфюмерного искусства уже более столетия.',
                characteristics: {Объем: '50', 'Тип продукта': 'Парфюмерная вода', 'Для кого': 'Для женщин', 'Группа ароматов': 'Цветочные, Альдегидные', Страна: 'Франция', Парфюмер: 'Ernest Beaux', Сегмент: 'Селективная', Стойкость: 'Стойкий 6-10 ч.'},
                isNew: false,
                popularity: 2,
                tags: ['gift']
            },
            {
                sku: 'p006',
                title: 'Dior Sauvage',
                brand: 'Dior',
                price: 7200,
                category: 'men',
                images: ['Photo_detail.png', 'Photo_detail.png'],
                volumes: ['60 мл', '100 мл'],
                description: 'Свежий, пряный и древесный. Магнетический аромат, в котором раскрываются ноты бергамота, перца и амброксана.',
                characteristics: {Объем: '100', 'Тип продукта': 'Туалетная вода', 'Для кого': 'Для мужчин', 'Группа ароматов': 'Древесные, Пряные', Страна: 'Франция', Парфюмер: 'François Demachy', Сегмент: 'Селективная', Стойкость: 'Стойкий 8-10 ч.'},
                isNew: false,
                popularity: 6,
                tags: ['summer']
            }
        ],
        cart: {},
        cartSelection: {},
        cartShareSkus: [],
        favorites: JSON.parse(localStorage.getItem('favorites') || '[]'),
        searchHistory: JSON.parse(localStorage.getItem('searchHistory') || '[]'),
        orders: JSON.parse(localStorage.getItem('orders') || '[]'),
        viewedSkus: JSON.parse(localStorage.getItem('viewedSkus') || '[]'),
        currentCategory: 'all',
        selectedBrands: [],
        currentSort: 'popular',
        searchQuery: '',
        isSearchMode: false,
        currentProduct: null,
        profileView: 'home',
        profileSelectedOrderId: null,
        profileDocument: null,
        bannerIndex: 0
    };

    const searchRecommendations = [
        'Хиты Kilian Paris',
        'Свежесть и цитрусы',
        'Редкая ниша',
        'Ароматы-невидимки',
        'Новинки недели',
        'Хиты Kilian Paris',
        'Свежесть и цитрусы',
        'Редкая ниша',
        'Ароматы-невидимки'
    ];

    const DETAIL_FAVORITE_ICON_ACTIVE = 'icon/favorite.svg?v=2';
    const DETAIL_FAVORITE_ICON_EMPTY = 'icon/favorite_empty.svg?v=2';

    let deferredInstallPrompt = null;

    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredInstallPrompt = e;
    });

    window.addEventListener('appinstalled', () => {
        deferredInstallPrompt = null;
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        renderProducts();
        initBanner();
        initSearch();
        updateBadges();
        loadUserData();
        renderOrders();
        renderViewedProducts();
        setProfileView('home', { skipScroll: true, skipBackSync: true });

        // Set default sort radio to match state
        updateSortRadio();
        buildBrandList();
    });

    function attachHorizontalSwipe(element, options = {}) {
        if (!element) return;

        const threshold = options.threshold || 50;
        let startX = 0;
        let startY = 0;
        let lastX = 0;
        let lastY = 0;
        let locked = null;
        let swipedAt = 0;

        element.addEventListener('touchstart', (e) => {
            const touch = e.touches && e.touches[0];
            if (!touch) return;
            startX = touch.clientX;
            startY = touch.clientY;
            lastX = startX;
            lastY = startY;
            locked = null;
        }, { passive: true });

        element.addEventListener('touchmove', (e) => {
            const touch = e.touches && e.touches[0];
            if (!touch) return;

            lastX = touch.clientX;
            lastY = touch.clientY;

            const dx = lastX - startX;
            const dy = lastY - startY;

            if (locked === null && (Math.abs(dx) > 6 || Math.abs(dy) > 6)) {
                locked = Math.abs(dx) > Math.abs(dy) ? 'x' : 'y';
            }

            if (locked === 'x') {
                e.preventDefault();
            }
        }, { passive: false });

        element.addEventListener('touchend', (e) => {
            const touch = e.changedTouches && e.changedTouches[0];
            if (touch) {
                lastX = touch.clientX;
                lastY = touch.clientY;
            }
            const dx = lastX - startX;
            const dy = lastY - startY;
            const isHorizontal = Math.abs(dx) > Math.abs(dy);
            const isSwipe = isHorizontal && Math.abs(dx) >= threshold;

            if (isSwipe) {
                swipedAt = Date.now();
                if (dx < 0 && typeof options.onSwipeLeft === 'function') options.onSwipeLeft();
                if (dx > 0 && typeof options.onSwipeRight === 'function') options.onSwipeRight();
            }
        }, { passive: true });

        element.addEventListener('touchcancel', () => {
            locked = null;
        }, { passive: true });

        if (options.preventClickAfterSwipe) {
            element.addEventListener('click', (e) => {
                if (Date.now() - swipedAt < 350) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            }, true);
        }
    }

    let bannerAutoTimer = null;
    let bannerResumeTimer = null;

    function pauseBannerAutoplay() {
        if (bannerAutoTimer) {
            clearInterval(bannerAutoTimer);
            bannerAutoTimer = null;
        }
        if (bannerResumeTimer) {
            clearTimeout(bannerResumeTimer);
        }
        bannerResumeTimer = setTimeout(startBannerAutoplay, 7000);
    }

    function startBannerAutoplay() {
        if (bannerAutoTimer) clearInterval(bannerAutoTimer);
        const slides = document.querySelectorAll('.banner-slide');
        if (!slides.length) return;
        bannerAutoTimer = setInterval(() => {
            setBanner((state.bannerIndex + 1) % slides.length);
        }, 5000);
    }

    // Banner Carousel
    function initBanner() {
        const dots = document.getElementById('bannerDots');
        const slides = document.querySelectorAll('.banner-slide');
        const carousel = document.getElementById('bannerCarousel');

        dots.innerHTML = '';
        slides.forEach((_, i) => {
            const dot = document.createElement('div');
            dot.className = 'dot' + (i === 0 ? ' active' : '');
            dot.onclick = () => {
                setBanner(i);
                pauseBannerAutoplay();
            };
            dots.appendChild(dot);
        });

        if (slides.length > 1) {
            attachHorizontalSwipe(carousel, {
                threshold: 36,
                onSwipeLeft: () => {
                    setBanner((state.bannerIndex + 1) % slides.length);
                    pauseBannerAutoplay();
                },
                onSwipeRight: () => {
                    setBanner((state.bannerIndex - 1 + slides.length) % slides.length);
                    pauseBannerAutoplay();
                }
            });
        }

        startBannerAutoplay();
    }

    function setBanner(index) {
        state.bannerIndex = index;
        document.getElementById('bannerSlides').style.transform = `translateX(-${index * 100}%)`;
        document.querySelectorAll('.pagination .dot').forEach((d, i) => {
            d.classList.toggle('active', i === index);
        });
    }

    // Sort Bottom Sheet
    function showSortSheet() {
        updateSortRadio();
        document.getElementById('sortOverlay').classList.add('show');
        document.getElementById('sortSheet').classList.add('show');
    }

    function closeSortSheet() {
        const sheet = document.getElementById('sortSheet');
        sheet.style.transition = 'transform 0.3s ease';
        sheet.style.transform = '';
        document.getElementById('sortOverlay').classList.remove('show');
        sheet.classList.remove('show');
    }

    function updateSortRadio() {
        const radios = document.querySelectorAll('#sortOptions input[name="sort"]');
        radios.forEach(r => {
            r.checked = r.value === state.currentSort;
        });
    }

    function applySort() {
        const selected = document.querySelector('#sortOptions input[name="sort"]:checked');
        if (selected) {
            state.currentSort = selected.value;
        }
        updateSortBtnState();
        closeSortSheet();
        renderProducts();
    }

    function cancelSort() {
        state.currentSort = 'popular';
        updateSortBtnState();
        closeSortSheet();
        renderProducts();
    }

    function updateSortBtnState() {
        const btn = document.getElementById('sortBtn');
        if (state.currentSort !== 'popular') {
            btn.classList.add('sort-active');
        } else {
            btn.classList.remove('sort-active');
        }
    }

    // Category Filters
    function toggleCategory(cat, btn) {
        if (state.currentCategory === cat) {
            state.currentCategory = 'all';
            btn.classList.remove('cat-active');
            btn.innerHTML = btn.dataset.category === 'women' ? 'Женские' : btn.dataset.category === 'men' ? 'Мужские' : 'Унисекс';
        } else {
            document.querySelectorAll('[data-category]').forEach(b => {
                b.classList.remove('cat-active');
                const c = b.dataset.category;
                b.innerHTML = c === 'women' ? 'Женские' : c === 'men' ? 'Мужские' : 'Унисекс';
            });
            state.currentCategory = cat;
            const label = cat === 'women' ? 'Женские' : cat === 'men' ? 'Мужские' : 'Унисекс';
            btn.classList.add('cat-active');
            btn.innerHTML = label + '<span class="filter-x" onclick="event.stopPropagation(); resetCategory()"><svg viewBox="0 0 8 8" fill="none"><path d="M1 1L7 7M7 1L1 7" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg></span>';
        }
        updateFilteredView();
        renderProducts();
    }

    function resetCategory() {
        state.currentCategory = 'all';
        document.querySelectorAll('[data-category]').forEach(b => {
            b.classList.remove('cat-active');
            const c = b.dataset.category;
            b.innerHTML = c === 'women' ? 'Женские' : c === 'men' ? 'Мужские' : 'Унисекс';
        });
        updateFilteredView();
        renderProducts();
    }

    // Brand Filter
    function buildBrandList() {
        const brands = [...new Set(state.products.map(p => p.brand))].sort();
        const container = document.getElementById('brandOptions');
        container.innerHTML = brands.map(b => `
            <label class="brand-sheet-option">
                <span>${b}</span>
                <input type="checkbox" name="brand" value="${b}">
                <span class="brand-checkbox"></span>
            </label>
        `).join('');
    }

    function showBrandSheet() {
        // Restore checkboxes to match current state
        document.querySelectorAll('#brandOptions input[name="brand"]').forEach(cb => {
            cb.checked = state.selectedBrands.includes(cb.value);
        });
        document.getElementById('brandOverlay').classList.add('show');
        document.getElementById('brandSheet').classList.add('show');
    }

    function closeBrandSheet() {
        const sheet = document.getElementById('brandSheet');
        sheet.style.transition = 'transform 0.3s ease';
        sheet.style.transform = '';
        document.getElementById('brandOverlay').classList.remove('show');
        sheet.classList.remove('show');
    }

    function applyBrands() {
        const checked = document.querySelectorAll('#brandOptions input[name="brand"]:checked');
        state.selectedBrands = Array.from(checked).map(cb => cb.value);
        updateBrandBtn();
        closeBrandSheet();
        renderProducts();
    }

    function cancelBrands() {
        state.selectedBrands = [];
        updateBrandBtn();
        closeBrandSheet();
        renderProducts();
    }

    function updateBrandBtn() {
        const btn = document.getElementById('brandBtn');
        const label = document.getElementById('brandLabel');
        const count = state.selectedBrands.length;

        if (count === 0) {
            btn.classList.remove('cat-active');
            btn.innerHTML = '<span id="brandBtnText">Бренд</span><svg width="10" height="6" viewBox="0 0 10 6" fill="none" style="margin-left:2px"><path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="brand-badge hidden" id="brandBadge">0</span>';
            label.classList.add('hidden');
        } else if (count === 1) {
            btn.classList.add('cat-active');
            btn.innerHTML = state.selectedBrands[0] + '<span class="filter-x" onclick="event.stopPropagation(); resetBrands()"><svg viewBox="0 0 8 8" fill="none"><path d="M1 1L7 7M7 1L1 7" stroke="#fff" stroke-width="1.5" stroke-linecap="round"/></svg></span>';
            label.textContent = state.selectedBrands[0];
            label.classList.remove('hidden');
        } else {
            btn.classList.add('cat-active');
            btn.innerHTML = '<span id="brandBtnText">Бренд</span><svg width="10" height="6" viewBox="0 0 10 6" fill="none" style="margin-left:2px"><path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="brand-badge" id="brandBadge">' + count + '</span>';
            label.classList.add('hidden');
        }
        updateFilteredView();
    }

    function resetBrands() {
        state.selectedBrands = [];
        document.getElementById('brandLabel').classList.add('hidden');
        updateBrandBtn();
        renderProducts();
    }

    // Swipe-to-dismiss for bottom sheets
    function setupSwipeDismiss(sheetEl, closeFn) {
        let startY = 0;
        let currentY = 0;
        let dragging = false;

        sheetEl.addEventListener('touchstart', function(e) {
            const touch = e.touches[0];
            startY = touch.clientY;
            currentY = startY;
            dragging = true;
            sheetEl.style.transition = 'none';
        }, { passive: true });

        sheetEl.addEventListener('touchmove', function(e) {
            if (!dragging) return;
            currentY = e.touches[0].clientY;
            const dy = currentY - startY;
            if (dy > 0) {
                sheetEl.style.transform = 'translateY(' + dy + 'px)';
            }
        }, { passive: true });

        sheetEl.addEventListener('touchend', function() {
            if (!dragging) return;
            dragging = false;
            const dy = currentY - startY;
            sheetEl.style.transition = 'transform 0.3s ease';
            if (dy > 80) {
                closeFn();
                setTimeout(() => { sheetEl.style.transform = ''; }, 300);
            } else {
                sheetEl.style.transform = 'translateY(0)';
            }
        });
    }

    setupSwipeDismiss(document.getElementById('sortSheet'), closeSortSheet);
    setupSwipeDismiss(document.getElementById('brandSheet'), closeBrandSheet);

    function updateFilteredView() {
        const hasFilter = state.currentCategory !== 'all' || state.selectedBrands.length > 0;
        const banner = document.querySelector('.banner-section');
        const collections = document.getElementById('collections');
        if (hasFilter) {
            banner.classList.add('hidden');
            collections.classList.add('hidden');
        } else {
            banner.classList.remove('hidden');
            collections.classList.remove('hidden');
        }
    }

    function escapeHtml(text) {
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function initSearch() {
        const input = document.getElementById('searchInput');
        if (!input) return;

        input.addEventListener('input', (e) => {
            state.searchQuery = e.target.value;
            renderSearchOverlay();
        });

        input.addEventListener('keydown', (e) => {
            if (e.key !== 'Enter') return;
            const query = state.searchQuery.trim();
            if (query) saveSearchQuery(query);
            e.preventDefault();
            input.blur();
        });
    }

    function saveSearchQuery(query) {
        const normalized = query.trim();
        if (!normalized) return;

        state.searchHistory = state.searchHistory.filter((item) => item.toLowerCase() !== normalized.toLowerCase());
        state.searchHistory.unshift(normalized);
        state.searchHistory = state.searchHistory.slice(0, 10);
        localStorage.setItem('searchHistory', JSON.stringify(state.searchHistory));
    }

    function clearSearchHistory() {
        state.searchHistory = [];
        localStorage.setItem('searchHistory', JSON.stringify(state.searchHistory));
        renderSearchOverlay();
    }

    function setSearchQuery(query, shouldFocus = true) {
        const input = document.getElementById('searchInput');
        state.searchQuery = query;
        if (input) {
            input.value = query;
            if (shouldFocus) {
                input.focus({ preventScroll: true });
                const length = query.length;
                try {
                    input.setSelectionRange(length, length);
                } catch (e) {}
            }
        }
        renderSearchOverlay();
    }

    function clearSearchQuery() {
        setSearchQuery('', true);
    }

    function getProductWord(count) {
        const mod10 = count % 10;
        const mod100 = count % 100;
        if (mod10 === 1 && mod100 !== 11) return 'товар';
        if (mod10 >= 2 && mod10 <= 4 && (mod100 < 12 || mod100 > 14)) return 'товара';
        return 'товаров';
    }

    function renderSearchResults(query) {
        const content = document.getElementById('searchContent');
        if (!content) return;

        const products = getFilteredProducts(query);
        content.innerHTML = `
            <div class="search-results-title">Найдено ${products.length} ${getProductWord(products.length)}</div>
            <div class="products search-products-grid" id="searchProductsGrid"></div>
        `;

        const grid = document.getElementById('searchProductsGrid');
        if (!grid) return;

        if (products.length === 0) {
            grid.innerHTML = '';
            return;
        }

        renderCardsInGrid(grid, products, 'search-imgs');
    }

    function renderSearchHints() {
        const content = document.getElementById('searchContent');
        if (!content) return;

        const hasHistory = state.searchHistory.length > 0;
        const historySection = hasHistory ? `
            <div class="search-section">
                <div class="search-section-head">
                    <div class="search-section-title">История поиска</div>
                    <button class="search-clear-history" id="searchHistoryClearBtn">Очистить</button>
                </div>
                <div class="search-list">
                    ${state.searchHistory.map((item, i) => `
                        <button class="search-list-item${i === state.searchHistory.length - 1 ? ' no-divider' : ''}" data-history-index="${i}">${escapeHtml(item)}</button>
                    `).join('')}
                </div>
            </div>
        ` : '';

        content.innerHTML = `
            ${historySection}
            <div class="search-section">
                <div class="search-section-title">Наши рекомендации</div>
                <div class="search-list">
                    ${searchRecommendations.map((item, i) => `
                        <button class="search-list-item${i === searchRecommendations.length - 1 ? ' no-divider' : ''}" data-recommend-index="${i}">${escapeHtml(item)}</button>
                    `).join('')}
                </div>
            </div>
        `;

        const clearHistoryBtn = document.getElementById('searchHistoryClearBtn');
        if (clearHistoryBtn) {
            clearHistoryBtn.addEventListener('click', clearSearchHistory);
        }

        content.querySelectorAll('[data-history-index]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const index = Number(btn.dataset.historyIndex);
                const value = state.searchHistory[index];
                if (value) setSearchQuery(value, true);
            });
        });

        content.querySelectorAll('[data-recommend-index]').forEach((btn) => {
            btn.addEventListener('click', () => {
                const index = Number(btn.dataset.recommendIndex);
                const value = searchRecommendations[index];
                if (value) setSearchQuery(value, true);
            });
        });
    }

    function toggleSearchClearButton() {
        const clearBtn = document.getElementById('searchClearBtn');
        if (!clearBtn) return;
        clearBtn.classList.toggle('show', state.searchQuery.trim().length > 0);
    }

    function renderSearchOverlay() {
        if (!state.isSearchMode) return;
        toggleSearchClearButton();

        const query = state.searchQuery.trim();
        if (query) {
            renderSearchResults(query);
        } else {
            renderSearchHints();
        }
    }

    function openSearchMode(shouldFocus = true) {
        if (state.isSearchMode) {
            if (shouldFocus) {
                const input = document.getElementById('searchInput');
                if (input) input.focus({ preventScroll: true });
            }
            return;
        }

        state.isSearchMode = true;
        document.body.classList.add('search-mode');
        document.getElementById('searchOverlay').classList.add('show');
        syncTelegramBackButton();

        const scroll = document.getElementById('searchScroll');
        if (scroll) scroll.scrollTop = 0;

        renderSearchOverlay();

        if (shouldFocus) {
            setTimeout(() => {
                const input = document.getElementById('searchInput');
                if (input) input.focus({ preventScroll: true });
            }, 0);
        }
    }

    function exitSearchMode(saveQuery = true) {
        if (!state.isSearchMode) return;

        const query = state.searchQuery.trim();
        if (saveQuery && query) {
            saveSearchQuery(query);
        }

        state.isSearchMode = false;
        state.searchQuery = '';

        const input = document.getElementById('searchInput');
        if (input) {
            input.value = '';
            input.blur();
        }

        document.body.classList.remove('search-mode');
        document.getElementById('searchOverlay').classList.remove('show');
        toggleSearchClearButton();
        renderProducts();
        syncTelegramBackButton();
    }

    // Filter by Tag
    function filterByTag(tag) {
        showPage('main');
        const filtered = state.products.filter(p => p.tags && p.tags.includes(tag));
        renderFilteredProducts(filtered);
    }

    // Render Products
    function getFilteredProducts(searchQuery = '') {
        let filtered = state.products;

        if (state.currentCategory !== 'all') {
            filtered = filtered.filter(p => p.category === state.currentCategory);
        }

        if (state.selectedBrands.length > 0) {
            filtered = filtered.filter(p => state.selectedBrands.includes(p.brand));
        }

        const normalizedQuery = (searchQuery || '').trim().toLowerCase();
        if (normalizedQuery) {
            filtered = filtered.filter((p) => {
                const title = p.title.toLowerCase();
                const brand = p.brand.toLowerCase();
                return title.includes(normalizedQuery) || brand.includes(normalizedQuery);
            });
        }

        filtered = [...filtered];
        if (state.currentSort === 'popular') {
            filtered.sort((a, b) => a.popularity - b.popularity);
        } else if (state.currentSort === 'price-asc') {
            filtered.sort((a, b) => a.price - b.price);
        } else if (state.currentSort === 'price-desc') {
            filtered.sort((a, b) => b.price - a.price);
        }

        return filtered;
    }

    function buildProductCardMarkup(p, imageContainerId) {
        return `
            <div class="card" onclick="openProduct('${p.sku}')">
                <div class="card-image-wrap">
                    <div class="card-image">
                        <div class="product-images" id="${imageContainerId}" style="transform: translateX(0)">
                            ${p.images.map(img => `<img src="${img}" class="product-image" alt="${p.title}">`).join('')}
                        </div>
                        <div class="card-fav ${state.favorites.includes(p.sku) ? 'active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${p.sku}')">
                            <svg viewBox="0 0 20 20" fill="none">
                                <path class="fav-fill" d="M9.9974 17.7917L8.78906 16.6917C4.4974 12.8 1.66406 10.2333 1.66406 7.08333C1.66406 4.51667 3.68073 2.5 6.2474 2.5C7.6974 2.5 9.08906 3.175 9.9974 4.24167C10.9057 3.175 12.2974 2.5 13.7474 2.5C16.3141 2.5 18.3307 4.51667 18.3307 7.08333C18.3307 10.2333 15.4974 12.8 11.2057 16.7L9.9974 17.7917Z"/>
                                <path class="fav-outline" d="M13.7474 2.5C12.2974 2.5 10.9057 3.175 9.9974 4.24167C9.08906 3.175 7.6974 2.5 6.2474 2.5C3.68073 2.5 1.66406 4.51667 1.66406 7.08333C1.66406 10.2333 4.4974 12.8 8.78906 16.7L9.9974 17.7917L11.2057 16.6917C15.4974 12.8 18.3307 10.2333 18.3307 7.08333C18.3307 4.51667 16.3141 2.5 13.7474 2.5ZM10.0807 15.4583L9.9974 15.5417L9.91406 15.4583C5.9474 11.8667 3.33073 9.49167 3.33073 7.08333C3.33073 5.41667 4.58073 4.16667 6.2474 4.16667C7.53073 4.16667 8.78073 4.99167 9.2224 6.13333H10.7807C11.2141 4.99167 12.4641 4.16667 13.7474 4.16667C15.4141 4.16667 16.6641 5.41667 16.6641 7.08333C16.6641 9.49167 14.0474 11.8667 10.0807 15.4583Z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="image-dots">
                        ${p.images.map((_, i) => `<div class="img-dot ${i === 0 ? 'active' : ''}"></div>`).join('')}
                    </div>
                </div>
                <div class="card-info">
                    <div class="card-prices">
                        <span class="card-price">${p.price.toLocaleString()} ₽</span>
                        ${p.oldPrice ? `<span class="card-old-price">${p.oldPrice.toLocaleString()} ₽</span>` : ''}
                    </div>
                    <div class="card-name">${p.title}</div>
                </div>
            </div>
        `;
    }

    function renderCardsInGrid(grid, products, idPrefix = 'imgs') {
        if (!grid) return;

        if (products.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6B7280;">Ничего не найдено</div>';
            return;
        }

        grid.innerHTML = products.map((p) => buildProductCardMarkup(p, `${idPrefix}-${p.sku}`)).join('');
        products.forEach(p => initImageSwipeById(`${idPrefix}-${p.sku}`, p.images.length));
    }

    function renderProducts() {
        const filtered = getFilteredProducts(state.isSearchMode ? state.searchQuery : '');
        renderFilteredProducts(filtered);
        if (state.isSearchMode) {
            renderSearchOverlay();
        }
    }

    function renderFilteredProducts(products) {
        const grid = document.getElementById('productsGrid');
        renderCardsInGrid(grid, products, 'imgs');
    }

    function initImageSwipe(sku, count) {
        initImageSwipeById(`imgs-${sku}`, count);
    }

    function initImageSwipeById(containerId, count) {
        const container = document.getElementById(containerId);
        if (!container || count <= 1) return;

        let index = 0;
        const dots = container.parentElement.nextElementSibling;

        const updateCardSlide = () => {
            container.style.transform = `translateX(-${index * 100}%)`;
            if (!dots) return;
            dots.querySelectorAll('.img-dot').forEach((d, i) => {
                d.classList.toggle('active', i === index);
            });
        };

        attachHorizontalSwipe(container, {
            threshold: 36,
            preventClickAfterSwipe: true,
            onSwipeLeft: () => {
                if (index < count - 1) {
                    index += 1;
                    updateCardSlide();
                }
            },
            onSwipeRight: () => {
                if (index > 0) {
                    index -= 1;
                    updateCardSlide();
                }
            }
        });
    }

    // Product Detail
    let detailImageIndex = 0;
    const viewerState = {
        images: [],
        realIndex: 0,
        virtualIndex: 0,
        touchStartX: 0,
        touchDeltaX: 0,
        isSwiping: false,
        isAnimating: false
    };

    function openProduct(sku) {
        if (state.isSearchMode) {
            exitSearchMode(true);
        }

        const p = state.products.find(x => x.sku === sku);
        if (!p) return;

        state.currentProduct = p;
        trackViewedProduct(sku);
        detailImageIndex = 0;
        const modal = document.getElementById('productModal');
        const content = document.getElementById('modalContent');

        const isFav = state.favorites.includes(sku);

        content.innerHTML = `
            <div class="detail-gallery">
                <div class="detail-images${p.images.length === 1 ? ' single' : ''}" id="detailImages">
                    ${p.images.map((img, i) => `
                    <div class="detail-image-wrap">
                        <img src="${img}" class="detail-image" onclick="openImageViewer(${i})">
                    </div>`).join('')}
                </div>
                <div class="detail-gallery-actions">
                    <button class="detail-img-btn${isFav ? ' fav-active' : ''}" id="detailFavBtn" onclick="toggleFavoriteDetail('${sku}')">
                        <img id="detailFavImg" src="${isFav ? DETAIL_FAVORITE_ICON_ACTIVE : DETAIL_FAVORITE_ICON_EMPTY}" width="20" height="20">
                    </button>
                    <button class="detail-img-btn" onclick="shareProduct()">
                        <img src="icon/share.svg" width="20" height="20">
                    </button>
                </div>
            </div>
            ${p.volumes && p.volumes.length > 0 ? `
            <div class="volume-selector">
                ${p.volumes.map((v, i) => `<button class="volume-btn ${i===0?'active':''}" onclick="selectVolume(this)">${v}</button>`).join('')}
            </div>` : ''}
            <div class="detail-brand-line">
                <span class="brand-name">${p.brand}</span><span class="brand-sep">›</span> ${p.title}
            </div>
            <div class="detail-price-row">
                <span class="detail-price">${p.price.toLocaleString()} ₽</span>
                ${p.oldPrice ? `<span class="detail-old-price">${p.oldPrice.toLocaleString()} ₽</span>` : ''}
            </div>
            <div class="detail-desc-card">
                <h3>Описание</h3>
                <div class="detail-desc-text collapsed" id="descText">${p.description}</div>
                <button class="detail-desc-toggle" id="descToggle" onclick="toggleDescription()">
                    Читать дальше <svg width="12" height="7" viewBox="0 0 12 7" fill="none"><path d="M1 1L6 6L11 1" stroke="#909096" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
            </div>
            <div class="detail-specs-card">
                <h3>Техническая спецификация</h3>
                ${Object.entries(p.characteristics).map(([k,v]) => `
                    <div class="spec-row">
                        <span class="spec-label">${k}</span>
                        <span class="spec-value">${v}</span>
                    </div>
                `).join('')}
            </div>
        `;

        renderDetailBottomBar(sku);

        modal.style.display = 'block';
        modal.scrollTop = 0;

        // Hide "Read more" button if description fits within 8 lines
        setTimeout(() => {
            const text = document.getElementById('descText');
            const toggle = document.getElementById('descToggle');
            if (text && toggle && text.scrollHeight <= text.clientHeight + 2) {
                toggle.style.display = 'none';
                text.classList.remove('collapsed');
            }
        }, 0);
        document.body.classList.add('detail-mode');
        document.body.style.overflow = 'hidden';
        syncTelegramBackButton();

    }

    function renderDetailBottomBar(sku) {
        const bar = document.getElementById('detailBottomBar');
        const qty = state.cart[sku] || 0;
        if (qty > 0) {
            bar.innerHTML = `
                <div class="detail-qty-controls">
                    <button class="detail-qty-btn" onclick="updateDetailQty('${sku}', -1)">−</button>
                    <span class="detail-qty-value">${qty}</span>
                    <button class="detail-qty-btn" onclick="updateDetailQty('${sku}', 1)">+</button>
                </div>
                <button class="detail-goto-cart-btn" onclick="goToCartFromDetail()">Перейти в корзину</button>
            `;
        } else {
            bar.innerHTML = `<button class="detail-add-btn" onclick="addToCartFromModal()">Добавить в корзину</button>`;
        }
    }

    function updateDetailQty(sku, delta) {
        state.cart[sku] = (state.cart[sku] || 0) + delta;
        if (state.cart[sku] <= 0) delete state.cart[sku];
        updateBadges();
        renderDetailBottomBar(sku);
    }

    function goToCartFromDetail() {
        closeModal();
        showPage('cart');
    }

    function setDetailImage(index) {
        detailImageIndex = index;
        document.getElementById('detailImages').style.transform = `translateX(-${index * 100}%)`;
    }

    function toggleDescription() {
        const text = document.getElementById('descText');
        const btn = document.getElementById('descToggle');
        const collapsed = text.classList.toggle('collapsed');
        if (collapsed) {
            btn.innerHTML = 'Читать дальше <svg width="12" height="7" viewBox="0 0 12 7" fill="none"><path d="M1 1L6 6L11 1" stroke="#909096" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            btn.classList.remove('expanded');
        } else {
            btn.innerHTML = 'Свернуть <svg width="12" height="7" viewBox="0 0 12 7" fill="none"><path d="M1 1L6 6L11 1" stroke="#909096" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            btn.classList.add('expanded');
        }
    }

    function selectVolume(btn) {
        btn.parentElement.querySelectorAll('.volume-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function toggleFavoriteDetail(sku) {
        toggleFavorite(sku);
        const isFav = state.favorites.includes(sku);
        const img = document.getElementById('detailFavImg');
        if (img) img.src = isFav ? DETAIL_FAVORITE_ICON_ACTIVE : DETAIL_FAVORITE_ICON_EMPTY;
        const btn = document.getElementById('detailFavBtn');
        if (btn) btn.classList.toggle('fav-active', isFav);
    }

    function shareProduct() {
        if (navigator.share && state.currentProduct) {
            navigator.share({ title: state.currentProduct.title, text: state.currentProduct.description });
        }
    }


    function showDetailMenu() {
        tg.showAlert('Меню в разработке');
    }

    function handleHeaderPrimaryAction() {
        if (state.isSearchMode) return;
        closeModal();
    }

    function handleNavBack() {
        if (state.isSearchMode) {
            exitSearchMode(true);
            return;
        }

        if (document.body.classList.contains('viewer-mode')) {
            closeImageViewer();
            return;
        }

        if (document.body.classList.contains('detail-mode')) {
            closeModal();
            return;
        }

        const profilePage = document.getElementById('profilePage');
        if (profilePage && profilePage.classList.contains('active') && state.profileView !== 'home') {
            handleProfileBackNavigation();
            return;
        }

        syncTelegramBackButton();
    }

    // Image Viewer
    function openImageViewer(index) {
        const p = state.currentProduct;
        if (!p || !Array.isArray(p.images) || p.images.length === 0) return;

        viewerState.images = p.images.slice();
        viewerState.realIndex = Math.max(0, Math.min(index, viewerState.images.length - 1));
        viewerState.virtualIndex = viewerState.images.length > 1 ? viewerState.realIndex + 1 : 0;
        viewerState.touchDeltaX = 0;
        viewerState.isSwiping = false;
        viewerState.isAnimating = false;

        renderViewerMain();
        renderViewerThumbs();
        updateViewerThumbs();

        document.getElementById('imageViewer').classList.add('show');
        document.body.classList.add('viewer-mode');
    }

    function switchViewerImage(index) {
        if (index < 0 || index >= viewerState.images.length) return;

        viewerState.isAnimating = false;
        viewerState.realIndex = index;
        if (viewerState.images.length > 1) {
            viewerState.virtualIndex = index + 1;
            setViewerTrackPosition(false);
        }
        updateViewerThumbs();
    }

    function closeImageViewer() {
        document.getElementById('imageViewer').classList.remove('show');
        document.body.classList.remove('viewer-mode');
        viewerState.touchDeltaX = 0;
        viewerState.isSwiping = false;
        viewerState.isAnimating = false;
        syncTelegramBackButton();
    }

    function renderViewerMain() {
        const main = document.getElementById('viewerMain');
        const images = viewerState.images;
        if (!main) return;

        if (images.length === 1) {
            main.innerHTML = `
                <div class="viewer-track" id="viewerTrack">
                    <div class="viewer-slide">
                        <img src="${images[0]}" alt="">
                    </div>
                </div>
            `;
            main.ontouchstart = null;
            main.ontouchmove = null;
            main.ontouchend = null;
            main.ontouchcancel = null;
            return;
        }

        const loopedImages = [images[images.length - 1], ...images, images[0]];
        main.innerHTML = `
            <div class="viewer-track" id="viewerTrack">
                ${loopedImages.map(img => `
                    <div class="viewer-slide">
                        <img src="${img}" alt="">
                    </div>
                `).join('')}
            </div>
        `;

        setViewerTrackPosition(false);

        const track = document.getElementById('viewerTrack');
        if (track) {
            track.addEventListener('transitionend', onViewerTrackTransitionEnd);
        }

        main.ontouchstart = onViewerTouchStart;
        main.ontouchmove = onViewerTouchMove;
        main.ontouchend = onViewerTouchEnd;
        main.ontouchcancel = onViewerTouchEnd;
    }

    function renderViewerThumbs() {
        const thumbs = document.getElementById('viewerThumbs');
        if (!thumbs) return;
        thumbs.innerHTML = viewerState.images.map((img, i) => `
            <div class="viewer-thumb ${i === viewerState.realIndex ? 'active' : ''}" onclick="switchViewerImage(${i})">
                <img src="${img}">
            </div>
        `).join('');
    }

    function updateViewerThumbs() {
        document.querySelectorAll('.viewer-thumb').forEach((t, i) => {
            t.classList.toggle('active', i === viewerState.realIndex);
        });
    }

    function setViewerTrackPosition(animated) {
        const track = document.getElementById('viewerTrack');
        if (!track) return;
        track.style.transition = animated ? 'transform 0.28s ease' : 'none';
        track.style.transform = `translateX(-${viewerState.virtualIndex * 100}%)`;
    }

    function moveViewer(step) {
        const total = viewerState.images.length;
        if (total <= 1 || viewerState.isAnimating) return;

        viewerState.isAnimating = true;
        viewerState.virtualIndex += step;
        viewerState.realIndex = (viewerState.realIndex + step + total) % total;
        setViewerTrackPosition(true);
        updateViewerThumbs();
    }

    function onViewerTrackTransitionEnd() {
        const total = viewerState.images.length;
        if (total <= 1) {
            viewerState.isAnimating = false;
            return;
        }

        if (viewerState.virtualIndex === 0) {
            viewerState.virtualIndex = total;
            setViewerTrackPosition(false);
        } else if (viewerState.virtualIndex === total + 1) {
            viewerState.virtualIndex = 1;
            setViewerTrackPosition(false);
        }

        viewerState.isAnimating = false;
    }

    function onViewerTouchStart(e) {
        if (viewerState.images.length <= 1 || viewerState.isAnimating) return;
        viewerState.isSwiping = true;
        viewerState.touchStartX = e.touches[0].clientX;
        viewerState.touchDeltaX = 0;
    }

    function onViewerTouchMove(e) {
        if (!viewerState.isSwiping) return;
        viewerState.touchDeltaX = e.touches[0].clientX - viewerState.touchStartX;
    }

    function onViewerTouchEnd() {
        if (!viewerState.isSwiping) return;

        const diffX = viewerState.touchDeltaX;
        viewerState.isSwiping = false;
        viewerState.touchDeltaX = 0;

        if (Math.abs(diffX) < 50) return;
        if (diffX < 0) moveViewer(1);
        else moveViewer(-1);
    }

    function closeModal() {
        document.getElementById('productModal').style.display = 'none';
        document.getElementById('imageViewer').classList.remove('show');
        document.body.classList.remove('viewer-mode');
        document.body.classList.remove('detail-mode');
        document.body.style.overflow = '';
        syncTelegramBackButton();
    }

    // Cart
    function quickAdd(sku) {
        state.cart[sku] = (state.cart[sku] || 0) + 1;
        updateBadges();
        if (document.getElementById('cartPage').classList.contains('active')) {
            renderCart();
        }
        try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}
    }

    function addToCartFromModal() {
        if (!state.currentProduct) return;
        const sku = state.currentProduct.sku;
        quickAdd(sku);
        renderDetailBottomBar(sku);
    }

    function formatRub(value) {
        return Number(value || 0).toLocaleString('ru-RU') + ' ₽';
    }

    function getCartItemsDetailed() {
        return Object.entries(state.cart).map(([sku, qty]) => {
            const product = state.products.find(x => x.sku === sku);
            if (!product) return null;
            return { sku, qty, product };
        }).filter(Boolean);
    }

    function syncCartSelection(items) {
        const next = {};
        items.forEach(({ sku }) => {
            next[sku] = Boolean(state.cartSelection[sku]);
        });
        state.cartSelection = next;
    }

    function getSelectedCartItems(items) {
        return items.filter(({ sku }) => state.cartSelection[sku]);
    }

    function areAllCartItemsSelected(items) {
        return items.length > 0 && items.every(({ sku }) => state.cartSelection[sku]);
    }

    function updateQuantity(sku, delta) {
        state.cart[sku] = (state.cart[sku] || 0) + delta;
        if (state.cart[sku] <= 0) {
            delete state.cart[sku];
            delete state.cartSelection[sku];
        }
        renderCart();
        updateBadges();
    }

    function toggleCartItemSelection(sku) {
        if (!(sku in state.cart)) return;
        state.cartSelection[sku] = !state.cartSelection[sku];
        renderCart();
    }

    function toggleCartSelectAll() {
        const items = getCartItemsDetailed();
        if (items.length === 0) return;

        const shouldSelectAll = !areAllCartItemsSelected(items);
        items.forEach(({ sku }) => {
            state.cartSelection[sku] = shouldSelectAll;
        });
        renderCart();
    }

    function renderCartBottomAction(items) {
        const bottomAction = document.getElementById('cartBottomAction');
        if (!bottomAction) return;

        const selected = getSelectedCartItems(items);
        if (selected.length === 0) {
            bottomAction.classList.add('disabled');
            bottomAction.innerHTML = '<span>Выберите товары</span>';
            return;
        }

        const total = selected.reduce((sum, { product, qty }) => sum + product.price * qty, 0);
        const oldTotal = selected.reduce((sum, { product, qty }) => sum + (product.oldPrice || product.price) * qty, 0);
        const showOldTotal = oldTotal > total;

        bottomAction.classList.remove('disabled');
        bottomAction.innerHTML = `
            <span class="cart-bottom-count">${selected.length} ${getProductWord(selected.length)}</span>
            <span class="cart-bottom-cta">К оформлению</span>
            <span class="cart-bottom-total">
                <span class="cart-bottom-total-main">${formatRub(total)}</span>
                ${showOldTotal ? `<span class="cart-bottom-total-old">${formatRub(oldTotal)}</span>` : ''}
            </span>
        `;
    }

    function renderCart() {
        const items = getCartItemsDetailed();
        const container = document.getElementById('cartItems');
        const empty = document.getElementById('emptyCart');
        const page = document.getElementById('cartPage');
        const headActions = document.getElementById('cartHeadActions');
        const offer = document.getElementById('cartOffer');
        const bottomAction = document.getElementById('cartBottomAction');
        const selectAllBtn = document.getElementById('cartSelectAllBtn');

        syncCartSelection(items);

        if (items.length === 0) {
            container.innerHTML = '';
            empty.classList.remove('hidden');
            headActions.classList.add('hidden');
            offer.classList.add('hidden');
            bottomAction.classList.add('hidden');
            page.classList.remove('has-items');
            closeCartSheets();
            return;
        }

        empty.classList.add('hidden');
        headActions.classList.remove('hidden');
        offer.classList.remove('hidden');
        bottomAction.classList.remove('hidden');
        page.classList.add('has-items');

        container.innerHTML = items.map(({ sku, qty, product }) => {
            const volume = (product.volumes && product.volumes[0]) ? product.volumes[0] : '—';
            const isChecked = Boolean(state.cartSelection[sku]);
            const itemPrice = product.price * qty;
            const itemOldPrice = product.oldPrice ? product.oldPrice * qty : null;
            return `
                <div class="cart-card">
                    <div class="cart-card-image-wrap">
                        <img src="${product.images[0]}" class="cart-card-image">
                    </div>
                    <div class="cart-card-main">
                        <div class="cart-card-top">
                            <div>
                                <div class="cart-card-title">${product.title}</div>
                                <div class="cart-card-volume">Объем: ${volume}</div>
                            </div>
                            <button class="cart-item-check${isChecked ? ' checked' : ''}" onclick="toggleCartItemSelection('${sku}')"></button>
                        </div>
                        <div class="cart-card-bottom">
                            <div class="cart-qty">
                                <button class="cart-qty-btn" onclick="updateQuantity('${sku}', -1)">−</button>
                                <span class="cart-qty-value">${qty}</span>
                                <button class="cart-qty-btn" onclick="updateQuantity('${sku}', 1)">+</button>
                            </div>
                            <div class="cart-price-col">
                                ${itemOldPrice ? `<div class="cart-old-price">${formatRub(itemOldPrice)}</div>` : ''}
                                <div class="cart-now-price">${formatRub(itemPrice)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        selectAllBtn.classList.toggle('checked', areAllCartItemsSelected(items));
        renderCartBottomAction(items);
    }

    function showCartClearSheet() {
        if (getCartItemsDetailed().length === 0) return;
        document.getElementById('cartShareSheet').classList.remove('show');
        document.getElementById('cartDeleteSheet').classList.add('show');
        document.getElementById('cartSheetOverlay').classList.add('show');
    }

    function getShareCartItems() {
        const items = getCartItemsDetailed();
        const selected = getSelectedCartItems(items);
        return selected.length > 0 ? selected : items;
    }

    function showCartShareSheet() {
        const shareItems = getShareCartItems();
        if (shareItems.length === 0) return;

        state.cartShareSkus = shareItems.map(({ sku }) => sku);
        const countEl = document.getElementById('cartShareCount');
        countEl.textContent = `${shareItems.length} ${getProductWord(shareItems.length)}`;

        document.getElementById('cartDeleteSheet').classList.remove('show');
        document.getElementById('cartShareSheet').classList.add('show');
        document.getElementById('cartSheetOverlay').classList.add('show');
    }

    function closeCartSheets() {
        document.getElementById('cartDeleteSheet').classList.remove('show');
        document.getElementById('cartShareSheet').classList.remove('show');
        document.getElementById('cartSheetOverlay').classList.remove('show');
        state.cartShareSkus = [];
    }

    function confirmClearCart() {
        state.cart = {};
        state.cartSelection = {};
        closeCartSheets();
        renderCart();
        updateBadges();
    }

    function buildCartShareText() {
        const items = getCartItemsDetailed().filter(({ sku }) => state.cartShareSkus.includes(sku));
        if (items.length === 0) return '';

        const lines = items.map(({ product, qty }) => {
            return `${product.title} × ${qty} — ${formatRub(product.price * qty)}`;
        });
        return `Товары из корзины:\n${lines.join('\n')}`;
    }

    async function copyTextToClipboard(text) {
        if (!text) return false;
        if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
            return true;
        }

        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return ok;
    }

    async function copyCartShareText() {
        const text = buildCartShareText();
        try {
            await copyTextToClipboard(text);
            tg.showAlert('Текст скопирован');
        } catch (e) {
            tg.showAlert('Не удалось скопировать');
        }
        closeCartSheets();
    }

    function shareCartViaTelegram() {
        const text = buildCartShareText();
        if (!text) return;
        window.open(`https://t.me/share/url?text=${encodeURIComponent(text)}`, '_blank');
        closeCartSheets();
    }

    function shareCartViaWhatsApp() {
        const text = buildCartShareText();
        if (!text) return;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        closeCartSheets();
    }

    async function shareCartViaMore() {
        const text = buildCartShareText();
        if (!text) return;

        if (navigator.share) {
            try {
                await navigator.share({ text });
            } catch (e) {}
        } else {
            try {
                await copyTextToClipboard(text);
                tg.showAlert('Текст скопирован');
            } catch (e) {
                tg.showAlert('Не удалось поделиться');
            }
        }
        closeCartSheets();
    }

    function handleCartBottomAction() {
        const selected = getSelectedCartItems(getCartItemsDetailed());
        if (selected.length === 0) return;
        tg.showAlert('Оформление выбранных товаров скоро будет доступно');
    }

    // Favorites
    function toggleFavorite(sku) {
        const idx = state.favorites.indexOf(sku);
        if (idx > -1) {
            state.favorites.splice(idx, 1);
        } else {
            state.favorites.push(sku);
            try { tg.HapticFeedback.impactOccurred('light'); } catch(e) {}
        }

        localStorage.setItem('favorites', JSON.stringify(state.favorites));
        updateBadges();
        renderProducts();
        if (document.getElementById('favoritesPage').classList.contains('active')) {
            renderFavorites();
        }
        if (document.getElementById('profilePage').classList.contains('active') && state.profileView === 'viewed') {
            renderViewedProducts();
        }
    }

    function renderFavorites() {
        const grid = document.getElementById('favoritesGrid');
        const empty = document.getElementById('emptyFavorites');
        const favs = state.products.filter(p => state.favorites.includes(p.sku));

        if (favs.length === 0) {
            grid.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');
        grid.innerHTML = favs.map(p => `
            <div class="card" onclick="openProduct('${p.sku}')">
                <div class="card-image-wrap">
                    <div class="card-image">
                        <img src="${p.images[0]}" style="width: 100%; height: 100%; object-fit: cover;">
                        <div class="card-fav active" onclick="event.stopPropagation(); toggleFavorite('${p.sku}')">
                            <svg viewBox="0 0 20 20" fill="none">
                                <path class="fav-fill" d="M9.9974 17.7917L8.78906 16.6917C4.4974 12.8 1.66406 10.2333 1.66406 7.08333C1.66406 4.51667 3.68073 2.5 6.2474 2.5C7.6974 2.5 9.08906 3.175 9.9974 4.24167C10.9057 3.175 12.2974 2.5 13.7474 2.5C16.3141 2.5 18.3307 4.51667 18.3307 7.08333C18.3307 10.2333 15.4974 12.8 11.2057 16.7L9.9974 17.7917Z"/>
                                <path class="fav-outline" d="M13.7474 2.5C12.2974 2.5 10.9057 3.175 9.9974 4.24167C9.08906 3.175 7.6974 2.5 6.2474 2.5C3.68073 2.5 1.66406 4.51667 1.66406 7.08333C1.66406 10.2333 4.4974 12.8 8.78906 16.7L9.9974 17.7917L11.2057 16.6917C15.4974 12.8 18.3307 10.2333 18.3307 7.08333C18.3307 4.51667 16.3141 2.5 13.7474 2.5ZM10.0807 15.4583L9.9974 15.5417L9.91406 15.4583C5.9474 11.8667 3.33073 9.49167 3.33073 7.08333C3.33073 5.41667 4.58073 4.16667 6.2474 4.16667C7.53073 4.16667 8.78073 4.99167 9.2224 6.13333H10.7807C11.2141 4.99167 12.4641 4.16667 13.7474 4.16667C15.4141 4.16667 16.6641 5.41667 16.6641 7.08333C16.6641 9.49167 14.0474 11.8667 10.0807 15.4583Z"/>
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="card-info">
                    <div class="card-prices">
                        <span class="card-price">${p.price.toLocaleString()} ₽</span>
                    </div>
                    <div class="card-name">${p.title}</div>
                </div>
            </div>
        `).join('');
    }

    function shouldShowTelegramBackButton() {
        if (state.isSearchMode) return true;
        if (document.body.classList.contains('detail-mode')) return true;
        if (document.body.classList.contains('viewer-mode')) return true;
        const profilePage = document.getElementById('profilePage');
        if (profilePage && profilePage.classList.contains('active') && state.profileView !== 'home') return true;
        return false;
    }

    function syncTelegramBackButton() {
        if (!tg.BackButton) return;
        tg.BackButton.offClick(handleNavBack);

        if (shouldShowTelegramBackButton()) {
            tg.BackButton.onClick(handleNavBack);
            tg.BackButton.show();
        } else {
            tg.BackButton.hide();
        }
    }

    function trackViewedProduct(sku) {
        const idx = state.viewedSkus.indexOf(sku);
        if (idx > -1) {
            state.viewedSkus.splice(idx, 1);
        }
        state.viewedSkus.unshift(sku);
        state.viewedSkus = state.viewedSkus.slice(0, 80);
        localStorage.setItem('viewedSkus', JSON.stringify(state.viewedSkus));

        if (document.getElementById('profilePage').classList.contains('active') && state.profileView === 'viewed') {
            renderViewedProducts();
        }
    }

    function getViewedProducts() {
        return state.viewedSkus
            .map((sku) => state.products.find((p) => p.sku === sku))
            .filter(Boolean);
    }

    function renderViewedProducts() {
        const grid = document.getElementById('profileViewedGrid');
        const empty = document.getElementById('profileViewedEmpty');
        if (!grid || !empty) return;

        const viewed = getViewedProducts();
        if (viewed.length === 0) {
            grid.innerHTML = '';
            empty.classList.remove('hidden');
            return;
        }

        empty.classList.add('hidden');
        grid.innerHTML = viewed.map((p) => {
            const isFav = state.favorites.includes(p.sku);
            const dotsCount = Math.min(3, Math.max(1, (p.images || []).length));
            const dots = Array.from({ length: dotsCount }, (_, idx) => `<span class="profile-viewed-dot${idx === 0 ? ' active' : ''}"></span>`).join('');

            return `
                <div class="profile-viewed-card" onclick="openProduct('${p.sku}')">
                    <div class="profile-viewed-image-wrap">
                        <img src="${p.images && p.images[0] ? p.images[0] : 'Photo_detail.png'}" alt="${p.title}">
                        <button class="profile-viewed-fav${isFav ? ' active' : ''}" onclick="event.stopPropagation(); toggleFavorite('${p.sku}')">
                            <svg width="22" height="22" viewBox="0 0 20 20" fill="none">
                                <path d="M9.9974 17.7917L8.78906 16.6917C4.4974 12.8 1.66406 10.2333 1.66406 7.08333C1.66406 4.51667 3.68073 2.5 6.2474 2.5C7.6974 2.5 9.08906 3.175 9.9974 4.24167C10.9057 3.175 12.2974 2.5 13.7474 2.5C16.3141 2.5 18.3307 4.51667 18.3307 7.08333C18.3307 10.2333 15.4974 12.8 11.2057 16.7L9.9974 17.7917Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                    <div class="profile-viewed-dots">${dots}</div>
                    <div class="profile-viewed-prices">
                        <span class="profile-viewed-price">${formatRub(p.price)}</span>
                        ${p.oldPrice ? `<span class="profile-viewed-old">${formatRub(p.oldPrice)}</span>` : ''}
                    </div>
                    <div class="profile-viewed-title">${p.title}</div>
                </div>
            `;
        }).join('');
    }

    function showProfilePopup(title, text = 'В разработке') {
        const overlay = document.getElementById('profilePopupOverlay');
        if (!overlay) return;
        document.getElementById('profilePopupTitle').textContent = title;
        document.getElementById('profilePopupText').textContent = text;
        overlay.classList.add('show');
    }

    function closeProfilePopup() {
        const overlay = document.getElementById('profilePopupOverlay');
        if (!overlay) return;
        overlay.classList.remove('show');
    }

    function showProfilePlaceholder(title) {
        showProfilePopup(title, 'В разработке');
    }

    async function handleAddToHomeScreen() {
        if (tg.addToHomeScreen) {
            try {
                tg.addToHomeScreen();
                return;
            } catch (e) {}
        }

        if (deferredInstallPrompt) {
            try {
                await deferredInstallPrompt.prompt();
                if (deferredInstallPrompt.userChoice) {
                    await deferredInstallPrompt.userChoice;
                }
                deferredInstallPrompt = null;
                return;
            } catch (e) {}
        }

        showProfilePopup(
            'Добавить на экран «Домой»',
            'На этом устройстве автоматическое добавление недоступно. Используйте пункт «Добавить на главный экран» в меню браузера.'
        );
    }

    function formatProfileDate(value) {
        if (!value) {
            return new Date().toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        const parsed = new Date(value);
        if (!Number.isNaN(parsed.getTime())) {
            return parsed.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        return String(value);
    }

    function resolveProductByOrderItem(item) {
        if (!item) return null;
        if (item.sku) {
            const bySku = state.products.find((p) => p.sku === item.sku);
            if (bySku) return bySku;
        }
        if (item.title) {
            const needle = String(item.title).trim().toLowerCase();
            return state.products.find((p) => p.title.trim().toLowerCase() === needle) || null;
        }
        return null;
    }

    function getOrderStatusMeta(status, index) {
        const value = String(status || '').toLowerCase();
        if (value.includes('отмен') || value.includes('cancel')) {
            return { key: 'cancelled', label: 'Отменен', actionType: 'repeat' };
        }
        if (value.includes('достав') || value.includes('deliver')) {
            return { key: 'delivered', label: 'Доставлен', actionType: 'repeat' };
        }
        if (value.includes('отправ') || value.includes('ship') || value.includes('transit')) {
            return { key: 'shipped', label: 'Отправлен', actionType: 'track' };
        }

        if (index === 0) {
            return { key: 'shipped', label: 'Отправлен', actionType: 'track' };
        }
        return { key: 'delivered', label: 'Доставлен', actionType: 'repeat' };
    }

    function getProfileOrders() {
        const rawOrders = Array.isArray(state.orders) ? state.orders : [];
        return rawOrders.map((order, index) => {
            const items = (Array.isArray(order.items) ? order.items : []).map((item) => {
                const product = resolveProductByOrderItem(item);
                const qty = Math.max(1, Number(item.qty) || 1);
                const price = Number(item.price_rub ?? item.price ?? product?.price ?? 0);
                const volume = item.volume || (product?.volumes && product.volumes[0]) || '50 мл';
                return {
                    sku: item.sku || product?.sku || '',
                    title: item.title || product?.title || 'Товар',
                    qty,
                    price,
                    volume,
                    image: item.image || (product?.images && product.images[0]) || 'Photo_detail.png'
                };
            });

            const itemCount = items.reduce((sum, item) => sum + item.qty, 0);
            const total = Number(order.total) || items.reduce((sum, item) => sum + item.price * item.qty, 0);
            const status = getOrderStatusMeta(order.status, index);
            const isShipped = status.key === 'shipped';

            return {
                id: String(order.id || `AP-${String(index + 1).padStart(6, '0')}`),
                date: formatProfileDate(order.date || order.createdAt),
                items,
                itemCount,
                total,
                statusKey: status.key,
                statusLabel: status.label,
                actionType: status.actionType,
                actionLabel: status.actionType === 'track' ? 'Отследить заказ' : 'Повторить заказ',
                deliveryService: order.deliveryService || 'СДЭК',
                deliveryMethod: order.deliveryMethod || (isShipped ? 'Пункт выдачи' : 'Курьером до двери'),
                address: order.address || (isShipped
                    ? 'г. Москва, ул. Маросейка, 4/2с1 (ПВЗ СДЭК)'
                    : 'г. Москва, ул. Маросейка, д. 4/2с1, кв. 15, под. 2, эт. 4'),
                recipient: order.recipient || order.name || '—',
                paymentType: order.paymentType || (isShipped ? 'Карта (**** 1234)' : 'При получении'),
                paymentMethod: order.paymentMethod || (isShipped ? 'Картой онлайн' : 'Картой или наличными'),
                deliveryCost: Number(order.deliveryCost ?? 0),
                previewImages: items.slice(0, 2).map((item) => item.image)
            };
        });
    }

    function getProfileOrderById(orderId) {
        return getProfileOrders().find((order) => String(order.id) === String(orderId)) || null;
    }

    function renderOrders() {
        const list = document.getElementById('profileOrdersList');
        if (!list) return;

        const orders = getProfileOrders();
        if (orders.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">📋</div>
                    <p>История заказов пока пуста</p>
                </div>
            `;
            return;
        }

        list.innerHTML = orders.map((order) => {
            const openDetailCall = `openProfileOrderDetail(${JSON.stringify(order.id)})`;
            const actionCall = `handleProfileOrderAction(${JSON.stringify(order.id)})`;
            const thumbs = order.previewImages.map((img) => `
                <div class="profile-order-thumb">
                    <img src="${img}" alt="">
                </div>
            `).join('');

            return `
                <div class="profile-order-card" onclick='${openDetailCall}'>
                    <div class="profile-order-top">
                        <span class="profile-order-status ${order.statusKey}">${order.statusLabel}</span>
                        <span class="profile-menu-chevron">›</span>
                    </div>
                    <div class="profile-order-grid">
                        <div class="profile-order-row">
                            <span class="profile-order-key">Номер заказа</span>
                            <span class="profile-order-value">${order.id}</span>
                        </div>
                        <div class="profile-order-row">
                            <span class="profile-order-key">Дата заказа</span>
                            <span class="profile-order-value">${order.date}</span>
                        </div>
                        <div class="profile-order-row">
                            <span class="profile-order-key">Сумма заказа</span>
                            <span class="profile-order-value">${formatRub(order.total)}</span>
                        </div>
                        <div class="profile-order-row">
                            <span class="profile-order-key">Количество позиций</span>
                            <span class="profile-order-value">${order.itemCount} шт.</span>
                        </div>
                    </div>
                    <div class="profile-order-thumbs">${thumbs}</div>
                    <button class="profile-order-action ${order.actionType === 'track' ? 'track' : 'repeat'}" onclick='event.stopPropagation(); ${actionCall}'>${order.actionLabel}</button>
                </div>
            `;
        }).join('');
    }

    function renderProfileDetailRows(rows) {
        return rows.map(([key, value]) => `
            <div class="profile-detail-row">
                <span class="profile-detail-key">${key}</span>
                <span class="profile-detail-value">${value}</span>
            </div>
        `).join('');
    }

    function renderProfileOrderDetail() {
        const container = document.getElementById('profileOrderDetailContent');
        if (!container) return;

        const order = getProfileOrderById(state.profileSelectedOrderId);
        if (!order) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">📦</div>
                    <p>Заказ не найден</p>
                </div>
            `;
            return;
        }

        const deliveryAddress = String(order.address || '—').replace(/,\s+/g, ',\n');
        const shippingRows = [
            ['Статус', order.statusLabel],
            ['Служба доставки', order.deliveryService],
            ['Способ доставки', order.deliveryMethod],
            ['Адрес', deliveryAddress],
            ['Получатель', order.recipient]
        ];
        const paymentRows = [
            ['Способ оплаты', order.paymentType],
            ['Метод оплаты', order.paymentMethod],
            ['Товары', formatRub(order.total)],
            ['Доставка', order.deliveryCost > 0 ? formatRub(order.deliveryCost) : 'Бесплатно'],
            ['Итого', formatRub(order.total + order.deliveryCost)]
        ];

        container.innerHTML = `
            <div class="profile-detail-card">
                ${renderProfileDetailRows([
                    ['Номер заказа', order.id],
                    ['Дата заказа', order.date]
                ])}
            </div>

            <div class="profile-detail-card">
                <div class="profile-detail-card-title">Информация о доставке</div>
                ${renderProfileDetailRows(shippingRows)}
                <button class="profile-order-action ${order.actionType === 'track' ? 'track' : 'repeat'}" onclick="handleProfileOrderAction(${JSON.stringify(order.id)})">${order.actionLabel}</button>
            </div>

            <div class="profile-detail-section">
                <div class="profile-detail-section-title">Состав заказа</div>
                <div class="profile-detail-section-meta">${order.itemCount} шт.</div>
            </div>

            <div class="profile-detail-items">
                ${order.items.map((item) => `
                    <div class="profile-detail-item">
                        <div class="profile-detail-item-image"><img src="${item.image}" alt=""></div>
                        <div>
                            <div class="profile-detail-item-title">${item.title}</div>
                            <div class="profile-detail-item-meta">Объем: ${item.volume}</div>
                            <div class="profile-detail-item-meta">Количество: ${item.qty} шт.</div>
                            <div class="profile-detail-item-price">${formatRub(item.price * item.qty)}</div>
                        </div>
                    </div>
                `).join('')}
            </div>

            <div class="profile-detail-card">
                <div class="profile-detail-card-title">Детали платежа</div>
                ${renderProfileDetailRows(paymentRows)}
            </div>
        `;
    }

    function repeatProfileOrder(orderId) {
        const order = getProfileOrderById(orderId);
        if (!order) return;

        let addedQty = 0;
        order.items.forEach((item) => {
            if (!item.sku) return;
            state.cart[item.sku] = (state.cart[item.sku] || 0) + item.qty;
            addedQty += item.qty;
        });

        updateBadges();
        if (document.getElementById('cartPage').classList.contains('active')) {
            renderCart();
        }

        if (addedQty > 0) {
            tg.showAlert('Товары добавлены в корзину');
        } else {
            showProfilePopup('Повторить заказ', 'Для этого заказа пока нет доступных товаров для повторения.');
        }
    }

    function handleProfileOrderAction(orderId) {
        const order = getProfileOrderById(orderId);
        if (!order) return;

        if (order.actionType === 'track') {
            showProfilePopup('Отследить заказ', 'В разработке');
            return;
        }

        repeatProfileOrder(orderId);
    }

    function openProfileOrders() {
        setProfileView('orders');
    }

    function openProfileOrderDetail(orderId) {
        state.profileSelectedOrderId = String(orderId);
        setProfileView('orderDetail');
    }

    function openProfileViewed() {
        setProfileView('viewed');
    }

    function renderProfileDocument() {
        const titleEl = document.getElementById('profileDocTitle');
        const frameEl = document.getElementById('profileDocFrame');
        if (!titleEl || !frameEl) return;

        const doc = state.profileDocument || { title: 'Документ', src: '' };
        titleEl.textContent = doc.title;
        if (frameEl.getAttribute('src') !== doc.src) {
            frameEl.setAttribute('src', doc.src);
        }
    }

    function openProfileDocument(type) {
        const docs = {
            rules: {
                title: 'Условия использования',
                src: 'docs/rules.pdf'
            },
            policy: {
                title: 'Политика конфиденциальности',
                src: 'docs/policy.pdf'
            }
        };

        const selected = docs[type];
        if (!selected) return;
        state.profileDocument = selected;
        setProfileView('doc');
    }

    function handleProfileBackNavigation() {
        if (state.profileView === 'orderDetail') {
            setProfileView('orders');
            return;
        }

        if (state.profileView === 'orders' || state.profileView === 'viewed' || state.profileView === 'doc') {
            state.profileSelectedOrderId = null;
            setProfileView('home');
            return;
        }

        syncTelegramBackButton();
    }

    function setProfileView(view, options = {}) {
        const views = {
            home: 'profileHomeView',
            orders: 'profileOrdersView',
            orderDetail: 'profileOrderDetailView',
            viewed: 'profileViewedView',
            doc: 'profileDocView'
        };

        const normalizedView = views[view] ? view : 'home';
        state.profileView = normalizedView;

        Object.values(views).forEach((id) => {
            const node = document.getElementById(id);
            if (!node) return;
            node.classList.toggle('active', id === views[normalizedView]);
        });

        if (normalizedView === 'orders') {
            renderOrders();
        } else if (normalizedView === 'orderDetail') {
            renderProfileOrderDetail();
        } else if (normalizedView === 'viewed') {
            renderViewedProducts();
        } else if (normalizedView === 'doc') {
            renderProfileDocument();
        }

        if (!options.skipBackSync) {
            syncTelegramBackButton();
        }
        if (!options.skipScroll) {
            window.scrollTo(0, 0);
        }
    }

    // Navigation
    function showPage(page) {
        if (page !== 'main' && state.isSearchMode) {
            exitSearchMode(false);
        }
        if (page !== 'cart') {
            closeCartSheets();
        }

        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));

        const filtersWrap = document.querySelector('.filters-wrap');
        const content = document.querySelector('.content');

        if (page === 'main') {
            document.getElementById('mainPage').classList.add('active');
            document.querySelectorAll('.tab')[0].classList.add('active');
            filtersWrap.classList.remove('hidden');
            content.style.paddingTop = '148px';
        } else if (page === 'favorites') {
            document.getElementById('favoritesPage').classList.add('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
            filtersWrap.classList.add('hidden');
            content.style.paddingTop = 'var(--content-top-no-filters, 96px)';
            renderFavorites();
        } else if (page === 'cart') {
            document.getElementById('cartPage').classList.add('active');
            document.querySelectorAll('.tab')[2].classList.add('active');
            filtersWrap.classList.add('hidden');
            content.style.paddingTop = 'var(--content-top-no-filters, 96px)';
            renderCart();
        } else if (page === 'profile') {
            document.getElementById('profilePage').classList.add('active');
            document.querySelectorAll('.tab')[3].classList.add('active');
            filtersWrap.classList.add('hidden');
            content.style.paddingTop = 'var(--content-top-no-filters, 96px)';
            state.profileSelectedOrderId = null;
            setProfileView('home', { skipScroll: true, skipBackSync: true });
        }

        window.scrollTo(0, 0);
        syncTelegramBackButton();
    }

    function focusSearch() {
        showPage('main');
        openSearchMode(true);
    }

    function closeApp() {
        tg.close();
    }

    function toggleMenu() {
        tg.showAlert('Меню в разработке');
    }

    function updateBadges() {
        const cartCount = Object.values(state.cart).reduce((a,b) => a+b, 0);
        const favCount = state.favorites.length;

        const cartBadge = document.getElementById('cartBadge');
        const favBadge = document.getElementById('favBadge');

        cartBadge.textContent = cartCount;
        cartBadge.classList.toggle('hidden', cartCount === 0);

        favBadge.textContent = favCount;
        favBadge.classList.toggle('hidden', favCount === 0);
    }

    function loadUserData() {
        const nameEl = document.getElementById('userName');
        const phoneEl = document.getElementById('userPhone');
        const avatarEl = document.getElementById('userAvatar');
        const tabAvatarEl = document.getElementById('tabAvatar');
        const user = tg.initDataUnsafe?.user;

        if (!nameEl || !phoneEl || !avatarEl || !tabAvatarEl) return;

        if (!user) {
            nameEl.textContent = 'Гость';
            phoneEl.textContent = 'Войдите через Telegram';
            avatarEl.textContent = 'Г';
            tabAvatarEl.innerHTML = '<span>Г</span>';
            return;
        }

        const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ').trim();
        nameEl.textContent = fullName || user.username || 'Пользователь';
        phoneEl.textContent = user.username ? `@${user.username}` : 'Пользователь Telegram';

        const initial = (fullName || user.first_name || user.username || 'Г').trim().charAt(0).toUpperCase();
        if (user.photo_url) {
            avatarEl.innerHTML = `<img src="${user.photo_url}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
            tabAvatarEl.innerHTML = `<img src="${user.photo_url}" class="tab-avatar-img">`;
        } else {
            avatarEl.textContent = initial || 'Г';
            tabAvatarEl.innerHTML = `<span>${initial || 'Г'}</span>`;
        }
    }

    // Checkout
    async function submitOrder() {
        const name = document.getElementById('checkoutName').value.trim();
        const phone = document.getElementById('checkoutPhone').value.trim();
        const address = document.getElementById('checkoutAddress').value.trim();
        const comment = document.getElementById('checkoutComment').value.trim();

        if (!name || !phone || !address) {
            tg.showAlert('Заполните все обязательные поля');
            return;
        }

        const items = Object.entries(state.cart).map(([sku, qty]) => {
            const p = state.products.find(x => x.sku === sku);
            return {sku, title: p.title, qty, price_rub: p.price};
        });

        const total = items.reduce((s, i) => s + i.price_rub * i.qty, 0);
        const orderId = 'AP-' + Date.now().toString().slice(-6);

        const order = {
            name, phone, address, comment, items, total,
            userId: tg.initDataUnsafe?.user?.id,
            username: tg.initDataUnsafe?.user?.username
        };

        document.getElementById('loadingOverlay').style.display = 'flex';

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(order)
            });
            const data = await res.json();

            if (data.success) {
                const orderRecord = {
                    id: orderId,
                    date: new Date().toISOString(),
                    items: items.map((i) => ({
                        sku: i.sku,
                        title: i.title,
                        qty: i.qty,
                        price_rub: i.price_rub
                    })),
                    total: total,
                    status: 'Отправлен',
                    deliveryService: 'СДЭК',
                    deliveryMethod: 'Пункт выдачи',
                    address: address,
                    recipient: name,
                    paymentType: 'Карта (**** 1234)',
                    paymentMethod: 'Картой онлайн',
                    deliveryCost: 0
                };
                state.orders.unshift(orderRecord);
                localStorage.setItem('orders', JSON.stringify(state.orders));

                state.cart = {};
                state.cartSelection = {};
                updateBadges();
                renderOrders();

                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('orderNumber').textContent = orderId;
                document.getElementById('successScreen').style.display = 'flex';
                tg.HapticFeedback.notificationOccurred('success');
            } else {
                throw new Error(data.error);
            }
        } catch (e) {
            document.getElementById('loadingOverlay').style.display = 'none';
            tg.showAlert('Ошибка отправки. Проверьте соединение.');
        }
    }

    function closeSuccess() {
        document.getElementById('successScreen').style.display = 'none';
        showPage('profile');
        renderOrders();
    }
</script>

</body>
</html>
