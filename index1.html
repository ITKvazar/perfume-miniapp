<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Original Perfume</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;padding:20px
        }
        .container{
            max-width:500px;margin:0 auto;background:#fff;
            border-radius:20px;padding:25px;box-shadow:0 20px 60px rgba(0,0,0,.3)
        }
        h1{text-align:center;color:#333;margin-bottom:10px}
        .subtitle{text-align:center;color:#666;margin-bottom:25px;font-size:14px}
        .product{
            display:flex;justify-content:space-between;align-items:center;
            padding:15px;margin:10px 0;background:#f8f9fa;border-radius:12px
        }
        .product-info h3{color:#333;font-size:16px}
        .product-info p{color:#667eea;font-weight:bold;font-size:18px;margin-top:5px}
        .btn-add{
            width:40px;height:40px;border-radius:50%;border:none;
            background:#667eea;color:#fff;font-size:20px;cursor:pointer
        }
        .btn-add.active{background:#28a745}
        .cart{
            margin-top:25px;padding:20px;background:#f8f9fa;
            border-radius:15px;display:none
        }
        .cart h2{color:#333;margin-bottom:15px;font-size:20px}
        .cart-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid #dee2e6}
        .total{text-align:right;font-size:24px;font-weight:bold;color:#667eea;margin:20px 0}
        .form{display:none;margin-top:20px}
        input,textarea{width:100%;padding:15px;margin:10px 0;border:2px solid #e9ecef;border-radius:12px;font-size:16px}
        input:focus,textarea:focus{outline:none;border-color:#667eea}
        .btn-submit{
            width:100%;padding:18px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:#fff;border:none;border-radius:12px;font-size:18px;font-weight:bold;cursor:pointer
        }
        .btn-submit:disabled{opacity:.6;cursor:not-allowed}
        .loading,.success{display:none;text-align:center;padding:20px}
        .spinner{width:50px;height:50px;border:5px solid #f3f3f3;border-top:5px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="container">
        <div id="shop">
            <h1>üõç Original Perfume</h1>
            <p class="subtitle">–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ø–∞—Ä—Ñ—é–º–µ—Ä–∏—è —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π</p>
            <div id="products"></div>
            <div class="cart" id="cart">
                <h2>üß∫ –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞</h2>
                <div id="cart-items"></div>
                <div class="total">–ò—Ç–æ–≥–æ: <span id="total">0</span> ‚ÇΩ</div>
                <button class="btn-submit" onclick="showForm()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>

        <div class="form" id="form">
            <h2>üìã –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ</h2>
            <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è" required>
            <input type="tel" id="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
            <input type="text" id="address" placeholder="–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏" required>
            <textarea id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3"></textarea>
            <button class="btn-submit" id="submitBtn" onclick="submitOrder()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–∫–∞–∑...</p>
        </div>

        <div class="success" id="success">
            <div class="success-icon">‚úÖ</div>
            <h2>–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç!</h2>
            <p>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: <b id="order-id"></b></p>
            <p style="margin-top:15px;color:#666">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</p>
        </div>
    </div>

    <script>
        // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô URL –∏–∑ Apps Script (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤!)
        const API_URL = 'https://script.google.com/macros/s/AKfycbznwEQk930Y6N37did0gEjKu2QJmPsPBu-_p1uWALSa2lihR2KBcmgKRKRHVRj4ASIhrg/exec';

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const products = [
            {sku: 'p001', title: 'Chanel No. 5 (50ml)', price: 8500},
            {sku: 'p002', title: 'Dior Sauvage (100ml)', price: 7200},
            {sku: 'p003', title: 'Tom Ford Black Orchid', price: 12000},
            {sku: 'p004', title: 'YSL Libre (50ml)', price: 6800}
        ];
        const cart = {};

        function renderProducts() {
            document.getElementById('products').innerHTML = products.map(p => `
                <div class="product">
                    <div class="product-info"><h3>${p.title}</h3><p>${p.price.toLocaleString()} ‚ÇΩ</p></div>
                    <button class="btn-add ${cart[p.sku] ? 'active' : ''}" onclick="addToCart('${p.sku}')">${cart[p.sku] || '+'}</button>
                </div>`).join('');
        }
        function addToCart(sku) {
            cart[sku] = (cart[sku] || 0) + 1;
            renderProducts();
            updateCart();
            tg.HapticFeedback.impactOccurred('light');
        }
        function updateCart() {
            const items = Object.entries(cart).map(([sku, qty]) => ({...products.find(p => p.sku === sku), qty}));
            if (!items.length) { document.getElementById('cart').style.display = 'none'; return; }
            document.getElementById('cart').style.display = 'block';
            document.getElementById('cart-items').innerHTML = items.map(i => `
                <div class="cart-item"><span>${i.title}</span><b>${i.qty} √ó ${i.price.toLocaleString()} ‚ÇΩ</b></div>`).join('');
            const total = items.reduce((s, i) => s + i.price * i.qty, 0);
            document.getElementById('total').textContent = total.toLocaleString();
            tg.MainButton.setText(`–û—Ñ–æ—Ä–º–∏—Ç—å –Ω–∞ ${total.toLocaleString()} ‚ÇΩ`);
            tg.MainButton.show();
            tg.MainButton.onClick(showForm);
        }
        function showForm() {
            document.getElementById('shop').style.display = 'none';
            document.getElementById('form').style.display = 'block';
            tg.MainButton.hide();
        }
        async function submitOrder() {
            const name = document.getElementById('name').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const address = document.getElementById('address').value.trim();
            const comment = document.getElementById('comment').value.trim();
            if (!name || !phone || !address) { tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è'); return; }

            const items = Object.entries(cart).map(([sku, qty]) => ({sku, title: products.find(p => p.sku === sku).title, qty, price_rub: products.find(p => p.sku === sku).price}));
            const total = items.reduce((s, i) => s + i.price_rub * i.qty, 0);
            const order = {name, phone, address, comment, items, total, userId: tg.initDataUnsafe?.user?.id, username: tg.initDataUnsafe?.user?.username};

            document.getElementById('form').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify(order)
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('success').style.display = 'block';
                    document.getElementById('order-id').textContent = data.orderId;
                    tg.HapticFeedback.notificationOccurred('success');
                    setTimeout(() => tg.close(), 3000);
                } else { throw new Error(data.error); }
            } catch (e) {
                console.error(e);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('form').style.display = 'block';
                document.getElementById('submitBtn').disabled = false;
                tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            }
        }
        renderProducts();
    </script>
</body>
</html>
